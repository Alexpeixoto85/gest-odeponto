
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Ponto - Versão Enterprise CLT</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #7209b7;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --danger-color: #f94144;
            --special-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #adb5bd;
            --sidebar-width: 280px;
            --header-height: 80px;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; }
        
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--dark-color); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1600px; margin: 0 auto; background-color: white; border-radius: 20px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25); overflow: hidden; display: flex; flex-direction: column; min-height: calc(100vh - 40px); }
        .main-content { display: flex; flex: 1; min-height: calc(100vh - var(--header-height) - 40px); }
        
        /* Header */
        .app-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 0 40px; height: var(--header-height); display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .app-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>'); background-size: cover; }
        
        .logo { display: flex; align-items: center; gap: 15px; z-index: 1; }
        .logo-icon { background: rgba(255, 255, 255, 0.2); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .logo-icon i { font-size: 24px; color: white; }
        .logo-text h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .logo-text p { font-size: 13px; opacity: 0.9; font-weight: 300; }
        
        .employee-selector { z-index: 10; margin-right: 20px; }
        .employee-selector select { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(5px); }
        .employee-selector select option { color: #333; background: white; }

        .current-date { text-align: right; z-index: 1; background: rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: var(--border-radius); backdrop-filter: blur(10px); }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, #2d3047 0%, #1c1e2e 100%); color: white; padding: 25px 20px; display: flex; flex-direction: column; position: relative; }
        .sidebar::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--accent-color), var(--success-color)); }
        
        .user-profile { text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 25px; }
        .user-avatar { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; border: 3px solid rgba(255, 255, 255, 0.2); }
        .user-badge { display: inline-block; background: var(--success-color); color: white; padding: 3px 10px; border-radius: 20px; font-size: 11px; margin-top: 8px; }
        
        .menu { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; border-radius: 12px; cursor: pointer; transition: var(--transition); font-weight: 500; color: rgba(255, 255, 255, 0.7); text-decoration: none; }
        .menu-item:hover { background: rgba(255, 255, 255, 0.1); color: white; transform: translateX(5px); }
        .menu-item.active { background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); color: white; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }

        /* Content */
        .content-area { flex: 1; padding: 30px 40px; overflow-y: auto; background: #f8fafc; }
        .content-section { display: none; animation: fadeIn 0.5s ease-out; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Components */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef; }
        .section-title { display: flex; align-items: center; gap: 15px; }
        .section-title i { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .section-title h2 { font-size: 28px; font-weight: 700; color: var(--dark-color); }
        
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--box-shadow); transition: var(--transition); border: 1px solid #e9ecef; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); }
        
        /* Table */
        .table-wrapper { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); margin: 30px 0; overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        .table thead { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); }
        .table th { padding: 18px 16px; text-align: left; color: white; font-weight: 600; font-size: 14px; text-transform: uppercase; }
        .table td { padding: 16px; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        
        .time-input { width: 100px; padding: 10px; text-align: center; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; }
        .time-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1); }
        
        /* Status Badges */
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        
        .row-domingo { background: #ffeaea !important; }
        .row-domingo td { color: #c0392b; }
        .row-feriado { background: #fce4ec !important; } 
        .row-feriado td { color: #880e4f; font-weight: 600; }
        .row-atestado { background: #e6f7ff !important; }
        .row-atestado td { color: #1890ff; font-weight: 600; }
        .row-folga { background: #fff8e1 !important; }
        .row-folga td { color: #ff8f00; font-weight: 600; }

        .saldo-positivo { color: var(--success-color); font-weight: bold; }
        .saldo-negativo { color: var(--danger-color); font-weight: bold; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); text-align: center; position: relative; }
        .stat-value { font-size: 28px; font-weight: 700; margin: 10px 0; color: var(--dark-color); }
        .stat-label { color: var(--gray-color); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }

        /* Banco de Horas */
        .banco-horas-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .banco-horas-card .stat-value { color: white; }
        .banco-horas-card .stat-label { color: rgba(255,255,255,0.8); }

        /* Buttons & Forms */
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 15px; transition: var(--transition); display: inline-flex; align-items: center; gap: 10px; color: white; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #2a9d8f); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #d00000); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #f3722c); }
        .btn-special { background: linear-gradient(135deg, var(--special-color), #7209b7); }
        .btn-dark { background: linear-gradient(135deg, #343a40, #212529); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        
        .form-control { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px; font-size: 14px; }
        .form-control:focus { border-color: var(--primary-color); outline: none; }

        /* Upload Zone */
        .upload-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fafafa; }
        .upload-zone:hover { border-color: var(--primary-color); background: #eef2ff; }
        .upload-zone i { font-size: 40px; color: var(--gray-color); margin-bottom: 15px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s; }
        .modal { background: white; border-radius: 20px; width: 100%; max-width: 600px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; background: none; border: none; }

        /* Tag List for Holidays */
        .tag-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .tag { background: #f0f0f0; padding: 8px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; border: 1px solid #ddd; }
        .tag i { cursor: pointer; color: var(--danger-color); }

        /* Modal de Backup */
        .backup-modal { background: white; border-radius: 20px; width: 100%; max-width: 450px; padding: 30px; position: relative; text-align: center; }
        .backup-modal h3 { color: var(--primary-color); margin-bottom: 15px; }
        .backup-modal p { color: #666; margin-bottom: 25px; line-height: 1.6; }
        .backup-buttons { display: flex; gap: 15px; justify-content: center; }

        /* Modal de Período */
        .periodo-modal { background: white; border-radius: 20px; width: 100%; max-width: 500px; padding: 30px; position: relative; }
        .periodo-modal h3 { color: var(--primary-color); margin-bottom: 20px; text-align: center; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state i { font-size: 60px; color: #ddd; margin-bottom: 20px; }
        .empty-state h3 { margin-bottom: 10px; color: #444; }

        /* Responsive */
        @media (max-width: 1024px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; padding: 15px; }
            .menu { flex-direction: row; flex-wrap: wrap; }
            .menu-item { flex: 1; justify-content: center; }
        }
        @media (max-width: 768px) {
            .app-header { flex-direction: column; height: auto; padding: 20px; gap: 15px; }
            .dashboard-grid, .cards-grid { grid-template-columns: 1fr; }
            .backup-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;" id="toastContainer"></div>

    <!-- Modal de Backup Automático -->
    <div id="modalBackupAuto" class="modal-overlay" style="z-index: 2000;">
        <div class="backup-modal">
            <h3><i class="fas fa-clock"></i> Tempo de Inatividade</h3>
            <p>Você está inativo há 1 minuto. Deseja continuar usando o sistema?</p>
            <div class="backup-buttons">
                <button class="btn btn-success" onclick="continuarSistema()"><i class="fas fa-play"></i> Sim, Continuar</button>
                <button class="btn btn-danger" onclick="sairComBackup()"><i class="fas fa-power-off"></i> Não, Sair</button>
            </div>
        </div>
    </div>

    <!-- Modal de Fechamento -->
    <div id="modalFechamento" class="modal-overlay" style="z-index: 2000;">
        <div class="backup-modal">
            <h3><i class="fas fa-exclamation-triangle"></i> Backup Necessário</h3>
            <p>Antes de fechar o sistema, é necessário realizar o backup dos dados. O backup será feito automaticamente agora.</p>
            <div class="backup-buttons">
                <button class="btn btn-success" onclick="fecharComBackup()"><i class="fas fa-download"></i> Fazer Backup e Sair</button>
                <button class="btn btn-warning" onclick="cancelarFechamento()"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Baixa de Banco de Horas -->
    <div id="modalBaixaBanco" class="modal-overlay" style="z-index: 2000;">
        <div class="backup-modal">
            <h3><i class="fas fa-piggy-bank"></i> Baixa no Banco de Horas</h3>
            <p>Registrar baixa de horas do banco para pagamento</p>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Funcionário</label>
                <select id="baixaFuncionario" class="form-control" style="margin-bottom: 0;"></select>
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Saldo Disponível</label>
                <input type="text" id="baixaSaldoDisponivel" class="form-control" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>Horas para Baixa (em minutos)</label>
                <input type="number" id="baixaHoras" class="form-control" placeholder="Ex: 120 (para 2 horas)" min="1">
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Tipo de Baixa</label>
                <select id="baixaTipo" class="form-control">
                    <option value="pagamento">Pagamento de Horas Extras</option>
                    <option value="compensacao">Compensação de Horas</option>
                    <option value="ajuste">Ajuste Administrativo</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Observação</label>
                <textarea id="baixaObservacao" class="form-control" rows="3" placeholder="Descreva o motivo da baixa..."></textarea>
            </div>
            
            <div class="backup-buttons">
                <button class="btn btn-success" onclick="confirmarBaixaBanco()"><i class="fas fa-check"></i> Confirmar Baixa</button>
                <button class="btn btn-warning" onclick="cancelarBaixaBanco()"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Relatório Consolidado por Período -->
    <div id="modalPeriodoConsolidado" class="modal-overlay" style="z-index: 2000;">
        <div class="periodo-modal">
            <button class="modal-close" onclick="fecharModalPeriodoConsolidado()">&times;</button>
            <h3><i class="fas fa-calendar-alt"></i> Relatório Consolidado por Período</h3>
            <p style="margin-bottom: 20px; color: #666;">Selecione o período para gerar o relatório consolidado de saldo de horas.</p>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label>Data Inicial</label>
                    <input type="date" id="periodoDataInicial" class="form-control">
                </div>
                <div style="flex: 1;">
                    <label>Data Final</label>
                    <input type="date" id="periodoDataFinal" class="form-control">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Funcionário (opcional)</label>
                <select id="periodoFuncionario" class="form-control">
                    <option value="todos">Todos os Funcionários</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label>Tipo de Relatório</label>
                <select id="periodoTipoRelatorio" class="form-control">
                    <option value="resumido">Resumido (Apenas totais)</option>
                    <option value="detalhado">Detalhado (Com dias)</option>
                    <option value="comparativo">Comparativo (Mês a mês)</option>
                </select>
            </div>
            
            <div class="backup-buttons">
                <button class="btn btn-primary" onclick="gerarRelatorioConsolidadoPeriodo()">
                    <i class="fas fa-file-pdf"></i> Gerar Relatório Consolidado
                </button>
                <button class="btn btn-warning" onclick="fecharModalPeriodoConsolidado()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Configurar Expediente -->
    <div id="modalConfigExpediente" class="modal-overlay" style="z-index: 2000;">
        <div class="modal">
            <button class="modal-close" onclick="fecharModalExpediente()">&times;</button>
            <h2 style="margin-bottom: 20px;"><i class="fas fa-clock"></i> Configurar Expediente</h2>
            
            <div id="expedienteContent">
                <!-- O conteúdo será gerado dinamicamente -->
            </div>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="salvarExpediente()"><i class="fas fa-save"></i> Salvar Configuração</button>
                <button class="btn btn-warning" onclick="fecharModalExpediente()"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon"><i class="fas fa-clock"></i></div>
                <div class="logo-text">
                    <h1>Ponto Enterprise</h1>
                    <p>Gestão CLT Inteligente</p>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="employee-selector">
                    <select id="headerFuncionarioSelect" onchange="trocarFuncionario(this.value)">
                        <option value="">Selecione um funcionário</option>
                    </select>
                </div>
                <div class="current-date">
                    <h3 id="currentDate"></h3>
                    <p id="currentTime"></p>
                </div>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="user-profile">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <div class="user-info">
                        <h3 id="sidebarNome">Nenhum funcionário</h3>
                        <p id="sidebarCargo">Selecione ou cadastre</p>
                        <div class="user-badge" id="sidebarStatus">Inativo</div>
                    </div>
                </div>

                <nav class="menu">
                    <a href="#" class="menu-item active" onclick="navegar('ponto', this)"><i class="fas fa-calendar-check"></i> Registro</a>
                    <a href="#" class="menu-item" onclick="navegar('feriados', this)"><i class="fas fa-calendar-star"></i> Dias Especiais</a>
                    <a href="#" class="menu-item" onclick="navegar('expediente', this)"><i class="fas fa-clock"></i> Expediente</a>
                    <a href="#" class="menu-item" onclick="navegar('funcionarios', this)"><i class="fas fa-users"></i> Funcionários</a>
                    <a href="#" class="menu-item" onclick="navegar('bancohoras', this)"><i class="fas fa-piggy-bank"></i> Banco de Horas</a>
                    <a href="#" class="menu-item" onclick="navegar('importacao', this)"><i class="fas fa-file-excel"></i> Importar Excel</a>
                    <a href="#" class="menu-item" onclick="navegar('relatorios', this)"><i class="fas fa-chart-pie"></i> Relatórios</a>
                    <a href="#" class="menu-item" onclick="navegar('relatoriosaldominutos', this)"><i class="fas fa-file-alt"></i> Relatório Saldo</a>
                    <a href="#" class="menu-item" onclick="navegar('config', this)"><i class="fas fa-cog"></i> Configurações</a>
                </nav>
            </aside>

            <main class="content-area">
                
                <section id="ponto" class="content-section active">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-calendar-alt"></i>
                            <h2>Registro de Ponto</h2>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="selectMes" class="form-control" style="width: auto; margin:0;"></select>
                            <select id="selectAno" class="form-control" style="width: auto; margin:0;"></select>
                            <button class="btn btn-success" onclick="salvarPontoAtual()"><i class="fas fa-save"></i> Salvar</button>
                        </div>
                    </div>

                    <div id="pontoEmptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-users"></i>
                        <h3>Nenhum funcionário cadastrado</h3>
                        <p>Para começar, cadastre um funcionário na seção "Funcionários".</p>
                        <button class="btn btn-primary" onclick="navegar('funcionarios', document.querySelector('a[onclick*=\"funcionarios\"]'))">
                            <i class="fas fa-user-plus"></i> Cadastrar Funcionário
                        </button>
                    </div>

                    <div id="pontoContent">
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="resumoTrabalhadas" style="color: var(--primary-color)">0h</div>
                                <div class="stat-label">Trabalhadas/Abonadas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="resumoExtras" style="color: var(--success-color)">0h</div>
                                <div class="stat-label">Extras (CLT)</div>
                            </div>
                            <div class="stat-card banco-horas-card">
                                <div class="stat-value" id="resumoBanco" style="color: white">0h</div>
                                <div class="stat-label">Banco de Horas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="resumoSaldo" style="color: var(--dark-color)">0h</div>
                                <div class="stat-label">Saldo Total</div>
                            </div>
                        </div>

                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Semana</th>
                                        <th>Entrada 1</th>
                                        <th>Saída 1</th>
                                        <th>Entrada 2</th>
                                        <th>Saída 2</th>
                                        <th>Total</th>
                                        <th>Saldo Dia</th>
                                        <th>Observação</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaPontoBody"></tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4><i class="fas fa-info-circle"></i> Legenda do Saldo:</h4>
                            <ul style="margin-top: 10px; color: #666; padding-left: 20px;">
                                <li><span class="saldo-positivo">Verde:</span> Horas extras trabalhadas (saldo positivo)</li>
                                <li><span class="saldo-negativo">Vermelho:</span> Horas faltantes (saldo negativo)</li>
                                <li>O saldo já considera a subtração da jornada diária</li>
                                <li>Domingos/Feriados: 100% hora extra se trabalhado</li>
                                <li>Sábado conforme expediente configurado</li>
                                <li>Saldo acumulado: positivo e negativo se compensam automaticamente</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section id="feriados" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-calendar-star" style="background: linear-gradient(135deg, var(--special-color), #a2d2ff);"></i>
                            <h2>Dias Especiais (Feriados, Folgas e Atestados) - <span id="currentFuncName">Funcionário</span></h2>
                        </div>
                    </div>
                    
                    <div id="feriadosEmptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-user-slash"></i>
                        <h3>Nenhum funcionário selecionado</h3>
                        <p>Selecione ou cadastre um funcionário para gerenciar dias especiais.</p>
                        <button class="btn btn-primary" onclick="navegar('funcionarios', document.querySelector('a[onclick*=\"funcionarios\"]'))">
                            <i class="fas fa-user-plus"></i> Cadastrar Funcionário
                        </button>
                    </div>
                    
                    <div id="feriadosContent">
                        <div class="card" style="margin-bottom: 30px;">
                            <h3>Cadastrar Feriado</h3>
                            <p style="margin-bottom: 20px; color: #666;">Os dias cadastrados aqui terão cálculo diferenciado (100% hora extra se trabalhados).</p>
                            <div style="display: flex; gap: 15px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label>Data do Feriado</label>
                                    <input type="date" id="inputFeriadoData" class="form-control" style="margin-bottom: 0;">
                                </div>
                                <div style="flex: 2;">
                                    <label>Descrição</label>
                                    <input type="text" id="inputFeriadoDesc" class="form-control" placeholder="Ex: Natal, Ano Novo" style="margin-bottom: 0;">
                                </div>
                                <button class="btn btn-special" onclick="App.adicionarFeriado()"><i class="fas fa-plus"></i> Adicionar</button>
                            </div>
                            <div style="margin-top: 30px;">
                                <h4>Feriados Cadastrados</h4>
                                <div class="tag-list" id="listaFeriados"></div>
                            </div>
                        </div>

                        <div class="card" style="margin-bottom: 30px;">
                            <h3>Cadastrar Folga</h3>
                            <p style="margin-bottom: 20px; color: #666;">Dias de folga concedidos (não são feriados nem domingos). Se trabalhados, serão 100% hora extra.</p>
                            <div style="display: flex; gap: 15px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label>Data da Folga</label>
                                    <input type="date" id="inputFolgaData" class="form-control" style="margin-bottom: 0;">
                                </div>
                                <div style="flex: 2;">
                                    <label>Descrição</label>
                                    <input type="text" id="inputFolgaDesc" class="form-control" placeholder="Ex: Folga compensada, Folga antecipada" style="margin-bottom: 0;">
                                </div>
                                <button class="btn btn-warning" onclick="App.adicionarFolga()"><i class="fas fa-umbrella-beach"></i> Adicionar Folga</button>
                            </div>
                            <div style="margin-top: 30px;">
                                <h4>Folgas Cadastradas</h4>
                                <div class="tag-list" id="listaFolgas"></div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Cadastrar Atestado Médico</h3>
                            <p style="margin-bottom: 20px; color: #666;">Abonará as horas da jornada normal nos dias e período informados.</p>
                            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                                <div style="flex: 1 1 150px;">
                                    <label>Data de Início</label>
                                    <input type="date" id="inputAtestadoData" class="form-control" style="margin-bottom: 0;">
                                </div>
                                <div style="flex: 1 1 100px;">
                                    <label>Qtd. Dias</label>
                                    <input type="number" id="inputAtestadoDias" class="form-control" value="1" min="1" style="margin-bottom: 0;">
                                </div>
                                <div style="flex: 1 1 100px;">
                                    <label>Horas/Dia (h)</label>
                                    <input type="number" id="inputAtestadoHoras" class="form-control" value="8" min="1" max="24" style="margin-bottom: 0;">
                                </div>
                                <button class="btn btn-warning" onclick="App.adicionarAtestado()" style="flex: 1 1 150px;"><i class="fas fa-notes-medical"></i> Adicionar Atestado</button>
                            </div>
                            <div style="margin-top: 30px;">
                                <h4>Atestados Cadastrados</h4>
                                <div class="tag-list" id="listaAtestados"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NOVA SEÇÃO: Configuração de Expediente -->
                <section id="expediente" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-clock" style="background: linear-gradient(135deg, var(--warning-color), #f3722c);"></i>
                            <h2>Configuração de Expediente</h2>
                        </div>
                        <button class="btn btn-primary" onclick="abrirModalExpediente()"><i class="fas fa-cog"></i> Configurar Expediente</button>
                    </div>

                    <div id="expedienteEmptyState" class="empty-state" style="display: block;">
                        <i class="fas fa-user-slash"></i>
                        <h3>Nenhum funcionário selecionado</h3>
                        <p>Selecione ou cadastre um funcionário para configurar o expediente.</p>
                        <button class="btn btn-primary" onclick="navegar('funcionarios', document.querySelector('a[onclick*=\"funcionarios\"]'))">
                            <i class="fas fa-user-plus"></i> Cadastrar Funcionário
                        </button>
                    </div>

                    <div id="expedienteContent" style="display: none;">
                        <div class="card">
                            <h3><i class="fas fa-calendar-week"></i> Horários de Expediente Configurados</h3>
                            <p style="margin-bottom: 20px; color: #666;">Configure os horários de trabalho para cada dia da semana. O sábado será calculado conforme os horários definidos abaixo.</p>
                            
                            <div class="table-wrapper">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Dia da Semana</th>
                                            <th>Trabalha?</th>
                                            <th>Entrada 1</th>
                                            <th>Saída 1</th>
                                            <th>Entrada 2</th>
                                            <th>Saída 2</th>
                                            <th>Jornada Diária</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaExpedienteBody">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4><i class="fas fa-info-circle"></i> Como funciona:</h4>
                                <ul style="margin-top: 10px; color: #666; padding-left: 20px;">
                                    <li><strong>Segunda a Sexta:</strong> Horário padrão conforme configuração</li>
                                    <li><strong>Sábado:</strong> Considerado hora extra apenas se trabalhar além do horário configurado</li>
                                    <li><strong>Domingo:</strong> Sempre 100% hora extra se trabalhado</li>
                                    <li><strong>Feriados/Folgas:</strong> 100% hora extra se trabalhado</li>
                                    <li>Se não configurar, usará jornada padrão de 8h/dia (seg-sex) e 4h para sábado</li>
                                </ul>
                            </div>
                            
                            <div class="btn-group" style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="abrirModalExpediente()">
                                    <i class="fas fa-edit"></i> Editar Configuração
                                </button>
                                <button class="btn btn-warning" onclick="App.resetarExpediente()">
                                    <i class="fas fa-undo"></i> Restaurar Padrão
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="funcionarios" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-users-cog"></i>
                            <h2>Gestão de Funcionários</h2>
                        </div>
                        <button class="btn btn-primary" onclick="abrirModalFuncionario()"><i class="fas fa-plus"></i> Novo Funcionário</button>
                    </div>

                    <div id="funcionariosEmptyState" class="empty-state" style="display: block;">
                        <i class="fas fa-users"></i>
                        <h3>Nenhum funcionário cadastrado</h3>
                        <p>Adicione seu primeiro funcionário para começar a usar o sistema.</p>
                        <button class="btn btn-primary" onclick="abrirModalFuncionario()">
                            <i class="fas fa-user-plus"></i> Cadastrar Primeiro Funcionário
                        </button>
                    </div>

                    <div class="cards-grid" id="listaFuncionariosGrid"></div>
                </section>

                <section id="bancohoras" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-piggy-bank"></i>
                            <h2>Banco de Horas</h2>
                        </div>
                        <div>
                            <button class="btn btn-warning" onclick="abrirModalBaixaBanco()">
                                <i class="fas fa-minus-circle"></i> Registrar Baixa
                            </button>
                        </div>
                    </div>

                    <div id="bancohorasEmptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-user-slash"></i>
                        <h3>Nenhum funcionário selecionado</h3>
                        <p>Selecione ou cadastre um funcionário para visualizar o banco de horas.</p>
                        <button class="btn btn-primary" onclick="navegar('funcionarios', document.querySelector('a[onclick*=\"funcionarios\"]'))">
                            <i class="fas fa-user-plus"></i> Cadastrar Funcionário
                        </button>
                    </div>

                    <div id="bancohorasContent">
                        <div class="card">
                            <h3><i class="fas fa-chart-line"></i> Histórico do Banco de Horas</h3>
                            <p style="margin-bottom: 20px; color: #666;">Visualize o saldo acumulado mês a mês. O banco de horas acumula os saldos positivos e negativos de todos os meses (eles se compensam automaticamente).</p>
                            
                            <div class="table-wrapper">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Mês/Ano</th>
                                            <th>Saldo do Mês</th>
                                            <th>Banco Anterior</th>
                                            <th>Banco Atualizado</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaBancoHorasBody"></tbody>
                                </table>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4><i class="fas fa-info-circle"></i> Como funciona o Banco de Horas:</h4>
                                <ul style="margin-top: 10px; color: #666; padding-left: 20px;">
                                    <li>Saldo positivo: horas extras trabalhadas</li>
                                    <li>Saldo negativo: horas a compensar</li>
                                    <li>O banco acumula mês a mês automaticamente</li>
                                    <li>Valores em vermelho indicam débito, verde crédito</li>
                                    <li><strong>Saldo líquido:</strong> positivo e negativo se compensam automaticamente</li>
                                    <li><strong>Exemplo:</strong> 30 minutos extra + 30 minutos faltante = saldo zero</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Nova seção: Histórico de Baixas -->
                        <div class="card" style="margin-top: 30px;">
                            <h3><i class="fas fa-history"></i> Histórico de Baixas</h3>
                            <p style="margin-bottom: 20px; color: #666;">Registro de todas as baixas realizadas no banco de horas.</p>
                            
                            <div class="table-wrapper">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Funcionário</th>
                                            <th>Horas Baixadas</th>
                                            <th>Tipo</th>
                                            <th>Observação</th>
                                            <th>Saldo Anterior</th>
                                            <th>Saldo Atual</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaBaixasBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="importacao" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-file-import"></i>
                            <h2>Importação em Massa</h2>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Importar de Excel (.xlsx ou .csv)</h3>
                        <p style="margin-bottom: 20px; color: #666;">
                            O sistema identifica dias automaticamente. <br>
                            <strong>Regras aplicadas:</strong><br>
                            - Domingos/Feriados/Folgas trabalhados = 100% Extra.<br>
                            - Sábados conforme expediente configurado.<br>
                            - Cálculo automático: saldo positivo e negativo se compensam
                        </p>
                        
                        <div class="upload-zone" onclick="abrirModalImportacao()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Clique para iniciar a importação</h4>
                            <p>Você selecionará o mês de referência antes de enviar o arquivo.</p>
                        </div>
                    </div>
                </section>

                <section id="relatorios" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-file-pdf"></i>
                            <h2>Relatórios Profissionais</h2>
                        </div>
                    </div>

                    <div class="cards-grid">
                        <div class="card">
                            <h3><i class="fas fa-print"></i> Relatório PDF Moderno</h3>
                            <p style="margin: 10px 0;">Gera documento oficial com cálculo de saldo, assinaturas e destaque para feriados e finais de semana.</p>
                            <button class="btn btn-danger" onclick="gerarPDFModerno()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-file-pdf"></i> Baixar PDF
                            </button>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-file-excel"></i> Exportar Dados</h3>
                            <p style="margin: 10px 0;">Baixe a tabela atual em formato CSV para backup.</p>
                            <button class="btn btn-success" onclick="exportarTabelaExcel()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-download"></i> Baixar Excel
                            </button>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-money-bill-wave"></i> Recibo de Horas Extras</h3>
                            <p style="margin: 10px 0;">Gera recibo formal para pagamento de horas extras com todos os detalhes.</p>
                            <button class="btn btn-special" onclick="gerarReciboHorasExtras()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-file-invoice-dollar"></i> Gerar Recibo
                            </button>
                        </div>
                    </div>
                </section>

                <!-- NOVA SEÇÃO: Relatório de Saldo de Horas -->
                <section id="relatoriosaldominutos" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-file-alt" style="background: linear-gradient(135deg, var(--warning-color), #f3722c);"></i>
                            <h2>Relatório de Saldo de Horas</h2>
                        </div>
                    </div>

                    <div class="cards-grid">
                        <div class="card">
                            <h3><i class="fas fa-users"></i> Relatório Geral de Saldos</h3>
                            <p style="margin: 10px 0;">Gera relatório completo com o saldo de horas de todos os funcionários, incluindo saldo total da empresa.</p>
                            <button class="btn btn-primary" onclick="gerarRelatorioSaldosGeral()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-download"></i> Baixar Relatório Geral
                            </button>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-user"></i> Relatório por Funcionário</h3>
                            <p style="margin: 10px 0;">Gera relatório detalhado do saldo de horas do funcionário atualmente selecionado.</p>
                            <button class="btn btn-success" onclick="gerarRelatorioSaldoFuncionario()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-download"></i> Baixar Relatório Individual
                            </button>
                        </div>
                        <div class="card">
                            <h3><i class="fas fa-calendar-alt"></i> Relatório Consolidado por Período</h3>
                            <p style="margin: 10px 0;">Gera relatório consolidado de saldo de horas por período personalizado (múltiplos meses).</p>
                            <button class="btn btn-special" onclick="abrirModalPeriodoConsolidado()" style="width: 100%; margin-top: 15px;">
                                <i class="fas fa-download"></i> Relatório por Período
                            </button>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 30px;">
                        <h3><i class="fas fa-chart-bar"></i> Visão Geral dos Saldos</h3>
                        <p style="margin-bottom: 20px; color: #666;">Resumo visual dos saldos de horas de todos os funcionários.</p>
                        
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Funcionário</th>
                                        <th>Cargo</th>
                                        <th>Matrícula</th>
                                        <th>Saldo Banco de Horas</th>
                                        <th>Status</th>
                                        <th>Banco Ativo</th>
                                        <th>Exportar</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaResumoSaldos">
                                    <!-- Será preenchido via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4><i class="fas fa-calculator"></i> Saldo Total da Empresa</h4>
                                <p id="saldoTotalEmpresa" style="font-size: 24px; font-weight: bold; margin-top: 5px;">0h 00m</p>
                            </div>
                            <button class="btn btn-dark" onclick="App.atualizarResumoSaldos()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </section>

                <section id="config" class="content-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-building"></i>
                            <h2>Configurações da Empresa</h2>
                        </div>
                    </div>
                    
                    <div class="cards-grid">
                        <div class="card">
                            <h3><i class="fas fa-info-circle"></i> Dados da Empresa</h3>
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Nome da Empresa</label>
                                <input type="text" class="form-control" id="confEmpresaNome" value="EXCELENCIA LINGERIE LTDA">
                            </div>
                            <div class="form-group">
                                <label>CNPJ</label>
                                <input type="text" class="form-control" id="confEmpresaCnpj" value="38.035.900/0007-32">
                            </div>
                            <div class="form-group">
                                <label>Endereço</label>
                                <input type="text" class="form-control" id="confEmpresaEndereco" value="PRUDENTE DE MORAIS, NATAL/RN">
                            </div>
                            <button class="btn btn-primary" onclick="salvarConfigEmpresa()">Salvar Dados</button>
                        </div>

                        <div class="card" style="border-top: 4px solid var(--warning-color);">
                            <h3><i class="fas fa-tools"></i> Manutenção do Sistema</h3>
                            <p style="margin: 10px 0; color: #666;">Ferramentas de backup e limpeza de dados.</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-dark" onclick="App.exportarBackup()">
                                    <i class="fas fa-download"></i> Backup Completo (JSON)
                                </button>
                                
                                <button class="btn btn-warning" onclick="document.getElementById('fileBackup').click()">
                                    <i class="fas fa-upload"></i> Restaurar Backup
                                </button>
                                <input type="file" id="fileBackup" hidden accept=".json" onchange="App.restaurarBackup(this)">

                                <hr style="margin: 10px 0; border: 0; border-top: 1px solid #eee;">
                                
                                <button class="btn btn-danger" onclick="App.limparSistema()">
                                    <i class="fas fa-trash-alt"></i> Resetar Sistema (Apagar Tudo)
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="modalFuncionario" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="fecharModalFuncionario()">&times;</button>
            <h2 style="margin-bottom: 20px;">Cadastrar Funcionário</h2>
            <div class="form-group">
                <label>Nome Completo</label>
                <input type="text" id="funcNome" class="form-control" placeholder="Ex: Maria Silva">
            </div>
            <div class="form-group">
                <label>Função/Cargo</label>
                <input type="text" id="funcCargo" class="form-control" placeholder="Ex: Vendedora">
            </div>
            <div class="form-group">
                <label>Código/Matrícula</label>
                <input type="text" id="funcCodigo" class="form-control" placeholder="Ex: 001">
            </div>
            <div class="form-group">
                <label>Jornada Diária (Horas)</label>
                <input type="number" id="funcJornada" class="form-control" value="8">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="funcBancoHorasAtivo" checked> Ativar Banco de Horas para este funcionário
                </label>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarFuncionarioModal()">Salvar</button>
                <button class="btn btn-warning" onclick="fecharModalFuncionario()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalImportacao" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="fecharModalImportacao()">&times;</button>
            <h2 style="margin-bottom: 20px;"><i class="fas fa-file-import"></i> Configurar Importação</h2>
            <p style="margin-bottom: 20px; color: #555;">Selecione a qual período este arquivo pertence para garantir que os dados sejam lançados corretamente.</p>
            
            <div class="form-group">
                <label>Mês de Referência</label>
                <select id="importMesRef" class="form-control"></select>
            </div>
            <div class="form-group">
                <label>Ano de Referência</label>
                <select id="importAnoRef" class="form-control"></select>
            </div>

            <div class="upload-zone" onclick="document.getElementById('fileUpload').click()" style="padding: 20px; margin-top: 20px;">
                <i class="fas fa-file-excel" style="font-size: 24px;"></i>
                <span id="importFileName">Clique para selecionar arquivo</span>
                <input type="file" id="fileUpload" hidden accept=".xlsx, .xls, .csv" onchange="prepararArquivo(this)">
            </div>
            
            <div class="btn-group" style="margin-top: 20px; width: 100%;">
                <button class="btn btn-success" style="flex: 1; justify-content: center;" onclick="executarImportacao()">Processar Importação</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ESTADO GLOBAL DO SISTEMA
        // ==========================================
        const App = {
            data: {
                empresa: {
                    nome: "EXCELENCIA LINGERIE LTDA",
                    cnpj: "38.035.900/0007-32",
                    endereco: "PRUDENTE DE MORAIS, NATAL/RN"
                },
                funcionarios: [], 
                registros: {},    
                diasEspeciais: {},
                bancoHoras: {}, // Banco de horas por funcionário
                historicoBancoHoras: {}, // Histórico mensal detalhado
                baixasBancoHoras: {}, // Histórico de baixas do banco de horas
                config: {
                    funcionarioAtualId: null,
                    backupAutoAtivo: true
                },
                expediente: {} // Nova propriedade para armazenar configurações de expediente
            },
            
            ui: {
                mesAtual: new Date().getMonth(),
                anoAtual: new Date().getFullYear(),
                arquivoParaImportar: null,
                ultimaAtividade: Date.now(),
                tempoInatividade: 60000, // 1 minuto em milissegundos
                monitorAtividade: null,
                fechamentoBloqueado: false
            },

            init: function() {
                this.loadFromStorage();
                
                // Sistema inicia sem funcionários cadastrados
                this.setupDates();
                this.renderAll();
                this.setupClock();
                this.iniciarMonitorAtividade();
                this.configurarBloqueioFechamento();
                
                // Verifica se há funcionários para mostrar estados vazios
                this.checkEmptyStates();
                // Atualiza o resumo de saldos
                this.atualizarResumoSaldos();
                // Renderiza histórico de baixas
                this.renderHistoricoBaixas();
                
                // IMPORTANTE: Calcula e atualiza automaticamente o banco de horas para todos os funcionários
                this.atualizarBancoHorasTodosFuncionarios();
                
                // Configurar datas padrão para o modal de período
                this.configurarDatasPadraoPeriodo();
                
                // CORREÇÃO: Atualizar exibição do banco de horas na inicialização
                setTimeout(() => {
                    this.atualizarExibicaoBancoHoras();
                }, 500);
                
                // Inicializar expediente padrão se não existir
                this.inicializarExpedientePadrao();
            },
            
            configurarDatasPadraoPeriodo: function() {
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const primeiroDiaMesAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
                
                // Formatar para YYYY-MM-DD
                const formatarData = (data) => {
                    return data.toISOString().split('T')[0];
                };
                
                document.getElementById('periodoDataInicial').value = formatarData(primeiroDiaMesAnterior);
                document.getElementById('periodoDataFinal').value = formatarData(hoje);
                
                // Preencher select de funcionários
                this.atualizarSelectFuncionariosPeriodo();
            },
            
            atualizarSelectFuncionariosPeriodo: function() {
                const select = document.getElementById('periodoFuncionario');
                select.innerHTML = '<option value="todos">Todos os Funcionários</option>';
                
                this.data.funcionarios.forEach(func => {
                    select.innerHTML += `<option value="${func.id}">${func.nome} (${func.codigo})</option>`;
                });
            },

            // CORREÇÃO: Atualizar exibição do banco de horas
            atualizarExibicaoBancoHoras: function() {
                const func = this.getFuncionarioAtual();
                if (!func) return;
                
                // Recalcular banco de horas
                const bancoHoras = this.calcularBancoHorasFuncionario(func.id, true);
                
                // Atualizar o resumo no painel
                document.getElementById('resumoBanco').textContent = this.minToTime(bancoHoras);
                
                // Atualizar a tabela de banco de horas
                this.renderBancoHoras();
                
                // Atualizar o saldo total
                this.updateDashboardTotals();
                
                console.log(`Banco de horas atualizado para ${func.nome}: ${this.minToTime(bancoHoras)}`);
            },

            // --- Atualiza banco de horas para TODOS os funcionários ---
            atualizarBancoHorasTodosFuncionarios: function() {
                this.data.funcionarios.forEach(func => {
                    if (func.bancoHorasAtivo) {
                        this.calcularBancoHorasFuncionario(func.id, true);
                    } else {
                        // Se banco de horas está inativo, zera o saldo
                        this.data.bancoHoras[func.id] = 0;
                    }
                });
                this.saveToStorage();
                this.atualizarExibicaoBancoHoras();
            },

            // --- Inicializar expediente padrão ---
            inicializarExpedientePadrao: function() {
                // Se não existir expediente no storage, inicializa com valores padrão
                if (!this.data.expediente) {
                    this.data.expediente = {};
                }
            },

            // --- Configuração de expediente ---
            getExpedienteFuncionario: function(funcId = null) {
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return null;
                
                // Se não existir expediente para este funcionário, cria um padrão
                if (!this.data.expediente[id]) {
                    this.data.expediente[id] = this.criarExpedientePadrao();
                }
                
                return this.data.expediente[id];
            },

            criarExpedientePadrao: function() {
                // Expediente padrão: segunda a sexta 8h, sábado 4h
                return {
                    segunda: { trab: true, e1: "08:00", s1: "12:00", e2: "13:00", s2: "17:00", jornada: 8 },
                    terca: { trab: true, e1: "08:00", s1: "12:00", e2: "13:00", s2: "17:00", jornada: 8 },
                    quarta: { trab: true, e1: "08:00", s1: "12:00", e2: "13:00", s2: "17:00", jornada: 8 },
                    quinta: { trab: true, e1: "08:00", s1: "12:00", e2: "13:00", s2: "17:00", jornada: 8 },
                    sexta: { trab: true, e1: "08:00", s1: "12:00", e2: "13:00", s2: "17:00", jornada: 8 },
                    sabado: { trab: true, e1: "08:00", s1: "12:00", e2: null, s2: null, jornada: 4 },
                    domingo: { trab: false, e1: null, s1: null, e2: null, s2: null, jornada: 0 }
                };
            },

            salvarExpedienteFuncionario: function(funcId, expediente) {
                this.data.expediente[funcId] = expediente;
                this.saveToStorage();
                this.renderExpediente();
                showToast('Expediente salvo com sucesso!', 'success');
            },

            resetarExpediente: function(funcId = null) {
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return;
                
                if (confirm('Deseja restaurar o expediente padrão para este funcionário?')) {
                    this.data.expediente[id] = this.criarExpedientePadrao();
                    this.saveToStorage();
                    this.renderExpediente();
                    this.renderPonto(); // Recalcular pontos com novo expediente
                    showToast('Expediente restaurado para o padrão!', 'success');
                }
            },

            renderExpediente: function() {
                const func = this.getFuncionarioAtual();
                if (!func) {
                    document.getElementById('expedienteEmptyState').style.display = 'block';
                    document.getElementById('expedienteContent').style.display = 'none';
                    return;
                }
                
                document.getElementById('expedienteEmptyState').style.display = 'none';
                document.getElementById('expedienteContent').style.display = 'block';
                
                const expediente = this.getExpedienteFuncionario();
                const tbody = document.getElementById('tabelaExpedienteBody');
                tbody.innerHTML = '';
                
                const dias = [
                    { chave: 'segunda', nome: 'Segunda-feira' },
                    { chave: 'terca', nome: 'Terça-feira' },
                    { chave: 'quarta', nome: 'Quarta-feira' },
                    { chave: 'quinta', nome: 'Quinta-feira' },
                    { chave: 'sexta', nome: 'Sexta-feira' },
                    { chave: 'sabado', nome: 'Sábado' },
                    { chave: 'domingo', nome: 'Domingo' }
                ];
                
                dias.forEach(dia => {
                    const config = expediente[dia.chave];
                    const html = `
                        <tr>
                            <td><strong>${dia.nome}</strong></td>
                            <td>
                                <span class="status-badge" style="background: ${config.trab ? 'var(--success-color)' : 'var(--danger-color)'}; color: white;">
                                    ${config.trab ? 'SIM' : 'NÃO'}
                                </span>
                            </td>
                            <td>${config.e1 || '-'}</td>
                            <td>${config.s1 || '-'}</td>
                            <td>${config.e2 || '-'}</td>
                            <td>${config.s2 || '-'}</td>
                            <td><strong>${config.jornada}h</strong></td>
                        </tr>
                    `;
                    tbody.innerHTML += html;
                });
            },

            // --- Monitor de Atividade ---
            iniciarMonitorAtividade: function() {
                const eventos = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                eventos.forEach(evento => {
                    document.addEventListener(evento, () => {
                        this.ui.ultimaAtividade = Date.now();
                        document.getElementById('modalBackupAuto').classList.remove('active');
                    }, { passive: true });
                });

                this.ui.monitorAtividade = setInterval(() => {
                    const tempoInativo = Date.now() - this.ui.ultimaAtividade;
                    if (tempoInativo > this.ui.tempoInatividade && this.data.config.backupAutoAtivo) {
                        document.getElementById('modalBackupAuto').classList.add('active');
                    }
                }, 1000);
            },

            configurarBloqueioFechamento: function() {
                this.ui.fechamentoBloqueado = true;
                window.addEventListener('beforeunload', (e) => {
                    if (this.ui.fechamentoBloqueado) {
                        e.preventDefault();
                        e.returnValue = 'Antes de fechar, é necessário fazer backup dos dados.';
                        mostrarModalFechamento();
                    }
                });
            },

            // --- Backup Automático ---
            fazerBackupAutomatico: function() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Backup_Automatico_PontoEnterprise.json';
                a.click();
                showToast('Backup automático realizado com sucesso!', 'success');
                return true;
            },

            // --- Gerenciamento de Dados ---
            saveToStorage: function() {
                localStorage.setItem('ponto_app_data_v8', JSON.stringify(this.data)); // Versão atualizada para v8
            },

            loadFromStorage: function() {
                // Primeiro tenta carregar a versão v8
                let raw = localStorage.getItem('ponto_app_data_v8');
                
                // Se não encontrar v8, tenta v7 para compatibilidade
                if (!raw) {
                    raw = localStorage.getItem('ponto_app_data_v7');
                }
                
                if (raw) {
                    const parsed = JSON.parse(raw);
                    this.data.empresa = parsed.empresa || this.data.empresa;
                    this.data.funcionarios = parsed.funcionarios || [];
                    this.data.registros = parsed.registros || {};
                    this.data.diasEspeciais = parsed.diasEspeciais || {};
                    this.data.bancoHoras = parsed.bancoHoras || {};
                    this.data.historicoBancoHoras = parsed.historicoBancoHoras || {};
                    this.data.baixasBancoHoras = parsed.baixasBancoHoras || {};
                    this.data.config = parsed.config || {};
                    this.data.expediente = parsed.expediente || {}; // Nova propriedade
                    
                    // Garantir que todos os funcionários tenham a propriedade bancoHorasAtivo
                    this.data.funcionarios.forEach(func => {
                        if (func.bancoHorasAtivo === undefined) {
                            func.bancoHorasAtivo = true;
                        }
                    });
                    
                    // Se veio da v7, converte estrutura antiga para nova
                    if (!parsed.expediente && localStorage.getItem('ponto_app_data_v7')) {
                        this.migrarDadosV7paraV8();
                    }
                }
            },

            // Migração de dados da versão 7 para 8
            migrarDadosV7paraV8: function() {
                console.log('Migrando dados da versão 7 para 8...');
                
                // Inicializar expediente para todos os funcionários existentes
                this.data.funcionarios.forEach(func => {
                    this.data.expediente[func.id] = this.criarExpedientePadrao();
                });
                
                // Converter dias especiais antigos para nova estrutura (adicionando folgas)
                Object.keys(this.data.diasEspeciais).forEach(funcId => {
                    if (this.data.diasEspeciais[funcId]) {
                        // Garantir que tenha a propriedade folgas
                        if (!this.data.diasEspeciais[funcId].folgas) {
                            this.data.diasEspeciais[funcId].folgas = [];
                        }
                    }
                });
                
                this.saveToStorage();
                console.log('Migração concluída!');
            },

            // --- Verificação de estados vazios ---
            checkEmptyStates: function() {
                const hasFuncionarios = this.data.funcionarios.length > 0;
                const hasFuncionarioAtual = this.data.config.funcionarioAtualId && 
                                           this.data.funcionarios.some(f => f.id === this.data.config.funcionarioAtualId);
                
                // Ponto
                if (!hasFuncionarioAtual) {
                    document.getElementById('pontoEmptyState').style.display = 'block';
                    document.getElementById('pontoContent').style.display = 'none';
                } else {
                    document.getElementById('pontoEmptyState').style.display = 'none';
                    document.getElementById('pontoContent').style.display = 'block';
                }
                
                // Feriados
                if (!hasFuncionarioAtual) {
                    document.getElementById('feriadosEmptyState').style.display = 'block';
                    document.getElementById('feriadosContent').style.display = 'none';
                } else {
                    document.getElementById('feriadosEmptyState').style.display = 'none';
                    document.getElementById('feriadosContent').style.display = 'block';
                }
                
                // Expediente
                if (!hasFuncionarioAtual) {
                    document.getElementById('expedienteEmptyState').style.display = 'block';
                    document.getElementById('expedienteContent').style.display = 'none';
                } else {
                    document.getElementById('expedienteEmptyState').style.display = 'none';
                    document.getElementById('expedienteContent').style.display = 'block';
                    this.renderExpediente();
                }
                
                // Banco de Horas
                if (!hasFuncionarioAtual) {
                    document.getElementById('bancohorasEmptyState').style.display = 'block';
                    document.getElementById('bancohorasContent').style.display = 'none';
                } else {
                    document.getElementById('bancohorasEmptyState').style.display = 'none';
                    document.getElementById('bancohorasContent').style.display = 'block';
                    this.renderBancoHoras();
                    this.renderHistoricoBaixas();
                }
                
                // Funcionários
                if (!hasFuncionarios) {
                    document.getElementById('funcionariosEmptyState').style.display = 'block';
                    document.getElementById('listaFuncionariosGrid').style.display = 'none';
                } else {
                    document.getElementById('funcionariosEmptyState').style.display = 'none';
                    document.getElementById('listaFuncionariosGrid').style.display = 'grid';
                }
            },

            // Métodos auxiliares para dias especiais por funcionário
            getDiasEspeciaisFuncionario: function(funcId = null) {
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return { feriados: [], folgas: [], atestados: [] };
                
                if (!this.data.diasEspeciais[id]) {
                    this.data.diasEspeciais[id] = { feriados: [], folgas: [], atestados: [] };
                }
                return this.data.diasEspeciais[id];
            },

            // --- BANCO DE HORAS MELHORADO ---
            calcularBancoHorasFuncionario: function(funcId = null, forceRecalc = false) {
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return 0;
                
                const func = this.data.funcionarios.find(f => f.id === id);
                if (!func) return 0;
                
                // Se banco de horas está inativo, retorna 0
                if (!func.bancoHorasAtivo) {
                    this.data.bancoHoras[id] = 0;
                    return 0;
                }
                
                // Se já temos o banco calculado e não for forçar recálculo, retornamos
                if (!forceRecalc && this.data.bancoHoras[id] !== undefined) {
                    return this.data.bancoHoras[id];
                }
                
                // Calcula o banco de horas somando todos os saldos mensais
                let bancoTotal = 0;
                const chavesRegistros = Object.keys(this.data.registros);
                
                for (const chave of chavesRegistros) {
                    if (chave.startsWith(`${id}_`)) {
                        const [_, ano, mes] = chave.split('_');
                        const saldoMes = this.calcularSaldoMes(id, parseInt(ano), parseInt(mes));
                        bancoTotal += saldoMes;
                        
                        // Registra no histórico mensal
                        this.registrarHistoricoMensal(id, parseInt(ano), parseInt(mes), saldoMes);
                    }
                }
                
                // Subtrai as baixas já realizadas
                const baixas = this.data.baixasBancoHoras[id] || [];
                const totalBaixas = baixas.reduce((total, baixa) => total + baixa.horas, 0);
                bancoTotal -= totalBaixas;
                
                // Salva no cache
                this.data.bancoHoras[id] = bancoTotal;
                return bancoTotal;
            },

            // Registra no histórico mensal de banco de horas
            registrarHistoricoMensal: function(funcId, ano, mes, saldoMes) {
                if (!this.data.historicoBancoHoras[funcId]) {
                    this.data.historicoBancoHoras[funcId] = {};
                }
                
                const chave = `${ano}_${mes}`;
                this.data.historicoBancoHoras[funcId][chave] = {
                    ano: ano,
                    mes: mes,
                    saldoMes: saldoMes,
                    dataRegistro: new Date().toISOString()
                };
            },

            // CÁLCULO DO SALDO DO MÊS MELHORADO COM EXPEDIENTE
            calcularSaldoMes: function(funcId, ano, mes) {
                const func = this.data.funcionarios.find(f => f.id === funcId);
                if (!func) return 0;
                
                const key = `${funcId}_${ano}_${mes}`;
                const registrosMes = this.data.registros[key] || {};
                const diasNoMes = new Date(ano, mes + 1, 0).getDate();
                
                let saldoMes = 0;
                
                for (let d = 1; d <= diasNoMes; d++) {
                    const dataObj = new Date(ano, mes, d);
                    const reg = registrosMes[d] || {};
                    const calculo = this.calcularDiaComExpediente(reg, func.jornada, dataObj, funcId);
                    
                    saldoMes += calculo.saldo;
                }
                
                return saldoMes;
            },

            // NOVO MÉTODO: Cálculo considerando expediente configurado
            calcularDiaComExpediente: function(reg, jornadaPadrao, dataObj, funcId = null) {
                const y = dataObj.getFullYear();
                const m = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                const d = dataObj.getDate().toString().padStart(2, '0');
                const dataFormatada = `${y}-${m}-${d}`;
                
                const diaSemana = dataObj.getDay(); 
                const isDomingo = diaSemana === 0;
                const isSabado = diaSemana === 6;
                const isFeriado = this.isFeriado(dataFormatada, funcId);
                const isFolga = this.isFolga(dataFormatada, funcId);
                const minutosAbonados = this.isAtestado(dataFormatada, funcId); 
                const isAtestadoDay = minutosAbonados > 0; 

                // Obter configuração de expediente para este dia
                const diasSemana = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];
                const diaSemanaChave = diasSemana[diaSemana];
                const expediente = this.getExpedienteFuncionario(funcId);
                const configDia = expediente ? expediente[diaSemanaChave] : null;

                let trabalhado = 0;
                if (reg) {
                    if (reg.e1 && reg.s1) trabalhado += (this.timeToMin(reg.s1) - this.timeToMin(reg.e1));
                    if (reg.e2 && reg.s2) trabalhado += (this.timeToMin(reg.s2) - this.timeToMin(reg.e2));
                }
                
                const teveBatida = trabalhado > 0;
                let saldo = 0;
                let jornadaEfetiva = jornadaPadrao * 60;
                let observacao = '';

                // **LÓGICA MELHORADA COM EXPEDIENTE CONFIGURADO**
                if (isAtestadoDay) {
                    jornadaEfetiva = minutosAbonados; 
                    if (!teveBatida) {
                        trabalhado = minutosAbonados; 
                        saldo = 0; // Atestado: não gera saldo positivo nem negativo
                        observacao = 'Atestado';
                    } else {
                        saldo = trabalhado - jornadaEfetiva;
                        observacao = 'Trabalhou com atestado';
                    }
                }
                else if (isDomingo || isFeriado || isFolga) {
                    // Para domingos, feriados e folgas, toda hora trabalhada é extra (100%)
                    jornadaEfetiva = 0;
                    if (teveBatida) {
                        saldo = trabalhado; // 100% extra
                        observacao = isDomingo ? 'Domingo' : isFeriado ? 'Feriado' : 'Folga';
                    } else {
                        observacao = isDomingo ? 'Domingo' : isFeriado ? 'Feriado' : 'Folga';
                    }
                }
                else if (isSabado) {
                    // Sábado: usa expediente configurado ou padrão de 4h
                    if (configDia && configDia.trab) {
                        jornadaEfetiva = configDia.jornada * 60;
                        if (teveBatida) {
                            saldo = trabalhado - jornadaEfetiva;
                            observacao = saldo > 0 ? 'Sábado (extra)' : (saldo < 0 ? 'Sábado (falta)' : 'Sábado');
                        } else {
                            // Se não trabalhou no sábado configurado, gera saldo negativo
                            saldo = -jornadaEfetiva;
                            observacao = 'Sábado (falta)';
                        }
                    } else {
                        // Sábado não trabalhado no expediente
                        if (teveBatida) {
                            saldo = trabalhado; // 100% extra se trabalhar em sábado não configurado
                            observacao = 'Sábado (extra)';
                        } else {
                            observacao = 'Sábado';
                        }
                    }
                }
                else {
                    // Dias normais: horas extras são o que excede a jornada
                    // Usa jornada do expediente se configurado
                    if (configDia && configDia.trab) {
                        jornadaEfetiva = configDia.jornada * 60;
                    }
                    
                    if (teveBatida) { 
                        saldo = trabalhado - jornadaEfetiva;
                        observacao = saldo > 0 ? 'Extra' : (saldo < 0 ? 'Falta' : 'Normal');
                    } else {
                        // Se não trabalhou em dia útil, gera saldo negativo
                        saldo = -jornadaEfetiva;
                        observacao = 'Falta';
                    }
                }

                return {
                    trabalhado: trabalhado,
                    saldo: saldo, // Este é o saldo líquido do dia (pode ser positivo ou negativo)
                    teveBatida: teveBatida,
                    isSpecial: isDomingo || isFeriado || isFolga,
                    isAtestadoDay: isAtestadoDay,
                    isDomingo: isDomingo,
                    isFeriado: isFeriado,
                    isFolga: isFolga,
                    isSabado: isSabado,
                    observacao: observacao
                };
            },

            // Método original mantido para compatibilidade
            calcularDiaMelhorado: function(reg, jornadaHoras, dataObj, funcId = null) {
                return this.calcularDiaComExpediente(reg, jornadaHoras, dataObj, funcId);
            },

            atualizarBancoHoras: function(funcId = null) {
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return;
                
                // Recalcula o banco de horas (forçando recálculo)
                this.data.bancoHoras[id] = this.calcularBancoHorasFuncionario(id, true);
                this.saveToStorage();
                
                // Atualiza o resumo de saldos
                this.atualizarResumoSaldos();
                
                // Atualiza a exibição
                this.atualizarExibicaoBancoHoras();
                
                // Renderiza novamente a seção de banco de horas se estiver ativa
                if (document.getElementById('bancohoras').classList.contains('active')) {
                    this.renderBancoHoras();
                    this.renderHistoricoBaixas();
                }
            },

            // --- Registro de Baixa no Banco de Horas ---
            registrarBaixaBancoHoras: function(funcId, horas, tipo, observacao) {
                const func = this.data.funcionarios.find(f => f.id === funcId);
                if (!func) {
                    showToast('Funcionário não encontrado', 'error');
                    return false;
                }
                
                if (!func.bancoHorasAtivo) {
                    showToast('Banco de horas não está ativo para este funcionário', 'error');
                    return false;
                }
                
                const saldoAtual = this.calcularBancoHorasFuncionario(funcId);
                if (horas > saldoAtual) {
                    showToast(`Saldo insuficiente. Saldo atual: ${this.minToTime(saldoAtual)}`, 'error');
                    return false;
                }
                
                // Cria registro da baixa
                const baixa = {
                    id: 'baixa_' + Date.now(),
                    funcionarioId: funcId,
                    funcionarioNome: func.nome,
                    data: new Date().toISOString().split('T')[0],
                    horas: horas,
                    tipo: tipo,
                    observacao: observacao,
                    saldoAnterior: saldoAtual,
                    saldoAtual: saldoAtual - horas
                };
                
                // Adiciona ao histórico de baixas
                if (!this.data.baixasBancoHoras[funcId]) {
                    this.data.baixasBancoHoras[funcId] = [];
                }
                this.data.baixasBancoHoras[funcId].push(baixa);
                
                // Atualiza o banco de horas
                this.atualizarBancoHoras(funcId);
                this.saveToStorage();
                
                showToast(`Baixa de ${this.minToTime(horas)} registrada para ${func.nome}`, 'success');
                return true;
            },

            // --- Renderização do Histórico de Baixas ---
            renderHistoricoBaixas: function(funcId = null) {
                const tbody = document.getElementById('tabelaBaixasBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const id = funcId || this.data.config.funcionarioAtualId;
                if (!id) return;
                
                const baixas = this.data.baixasBancoHoras[id] || [];
                
                if (baixas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                <i class="fas fa-history" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                <h4>Nenhuma baixa registrada</h4>
                                <p>As baixas aparecerão aqui quando forem registradas</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Ordena por data (mais recente primeiro)
                baixas.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                baixas.forEach(baixa => {
                    const dataFormatada = new Date(baixa.data).toLocaleDateString('pt-BR');
                    
                    const html = `
                        <tr>
                            <td>${dataFormatada}</td>
                            <td><strong>${baixa.funcionarioNome}</strong></td>
                            <td class="saldo-negativo">-${this.minToTime(baixa.horas)}</td>
                            <td>
                                <span class="status-badge" style="background: ${baixa.tipo === 'pagamento' ? 'var(--success-color)' : baixa.tipo === 'compensacao' ? 'var(--warning-color)' : 'var(--gray-color)'}; color: white;">
                                    ${baixa.tipo === 'pagamento' ? 'Pagamento' : baixa.tipo === 'compensacao' ? 'Compensação' : 'Ajuste'}
                                </span>
                            </td>
                            <td>${baixa.observacao || '-'}</td>
                            <td>${this.minToTime(baixa.saldoAnterior)}</td>
                            <td class="${baixa.saldoAtual >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(baixa.saldoAtual)}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', html);
                });
            },

            // --- Relatório de Saldos ---
            atualizarResumoSaldos: function() {
                const tbody = document.getElementById('tabelaResumoSaldos');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let saldoTotalEmpresa = 0;
                
                this.data.funcionarios.forEach(func => {
                    const banco = this.calcularBancoHorasFuncionario(func.id);
                    saldoTotalEmpresa += banco;
                    
                    const status = banco >= 0 ? 'Crédito' : 'Débito';
                    const corStatus = banco >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                    
                    const html = `
                        <tr>
                            <td><strong>${func.nome}</strong></td>
                            <td>${func.cargo}</td>
                            <td>${func.codigo}</td>
                            <td class="${banco >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">
                                <strong>${this.minToTime(banco)}</strong>
                            </td>
                            <td>
                                <span class="status-badge" style="background: ${corStatus}; color: white;">
                                    ${status}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge" style="background: ${func.bancoHorasAtivo ? 'var(--success-color)' : 'var(--danger-color)'}; color: white;">
                                    ${func.bancoHorasAtivo ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="gerarRelatorioSaldoFuncionarioEspecifico('${func.id}')">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', html);
                });
                
                // Atualiza o saldo total da empresa
                const saldoTotalElement = document.getElementById('saldoTotalEmpresa');
                if (saldoTotalElement) {
                    saldoTotalElement.textContent = this.minToTime(saldoTotalEmpresa);
                    saldoTotalElement.style.color = saldoTotalEmpresa >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                }
                
                return saldoTotalEmpresa;
            },

            // --- BACKUP E RESTAURAÇÃO ---
            exportarBackup: function() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = `Backup_PontoEnterprise_${date}.json`;
                a.click();
                showToast('Backup gerado com sucesso!', 'success');
            },

            restaurarBackup: function(input) {
                if (!input.files || !input.files[0]) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Validação básica
                        if (!importedData.funcionarios) {
                            throw new Error("Formato de arquivo inválido");
                        }
                        
                        if (confirm('Tem certeza? Isso substituirá todos os dados atuais pelos do backup.')) {
                            this.data = importedData;
                            this.saveToStorage();
                            this.init(); // Reinicia UI
                            showToast('Backup restaurado com sucesso!', 'success');
                        }
                    } catch (err) {
                        showToast('Erro ao ler arquivo de backup.', 'error');
                        console.error(err);
                    }
                    input.value = ''; // Limpa input
                };
                reader.readAsText(input.files[0]);
            },

            limparSistema: function() {
                if (confirm('ATENÇÃO: Isso apagará TODOS os dados, funcionários e registros. Não há como desfazer.\n\nDeseja continuar?')) {
                    if(confirm('Tem certeza absoluta?')) {
                        localStorage.removeItem('ponto_app_data_v8');
                        localStorage.removeItem('ponto_app_data_v7');
                        location.reload();
                    }
                }
            },

            addFuncionario: function(nome, cargo, codigo, jornada, bancoHorasAtivo = true) {
                const id = 'func_' + Date.now();
                const novo = { id, nome, cargo, codigo, jornada, bancoHorasAtivo };
                this.data.funcionarios.push(novo);
                this.data.config.funcionarioAtualId = id;
                
                // Criar expediente padrão para o novo funcionário
                this.data.expediente[id] = this.criarExpedientePadrao();
                
                this.saveToStorage();
                this.checkEmptyStates();
                this.atualizarResumoSaldos();
                this.atualizarSelectFuncionariosPeriodo();
                // Atualiza o banco de horas para o novo funcionário
                if (bancoHorasAtivo) {
                    this.calcularBancoHorasFuncionario(id, true);
                }
                return id;
            },

            toggleBancoHorasFuncionario: function(funcId) {
                const func = this.data.funcionarios.find(f => f.id === funcId);
                if (func) {
                    func.bancoHorasAtivo = !func.bancoHorasAtivo;
                    // Se desativou o banco de horas, zera o saldo
                    if (!func.bancoHorasAtivo) {
                        this.data.bancoHoras[funcId] = 0;
                    } else {
                        // Se ativou, recalcula o banco
                        this.calcularBancoHorasFuncionario(funcId, true);
                    }
                    this.saveToStorage();
                    this.renderListaFuncionarios();
                    this.renderBancoHoras();
                    this.atualizarResumoSaldos();
                    this.atualizarSelectFuncionariosPeriodo();
                    this.atualizarExibicaoBancoHoras();
                    showToast(`Banco de horas ${func.bancoHorasAtivo ? 'ativado' : 'desativado'} para ${func.nome}`, 'success');
                }
            },

            getFuncionarioAtual: function() {
                return this.data.funcionarios.find(f => f.id === this.data.config.funcionarioAtualId) || 
                       (this.data.funcionarios.length > 0 ? this.data.funcionarios[0] : null);
            },

            getKeyRegistro: function() {
                return `${this.data.config.funcionarioAtualId}_${this.ui.anoAtual}_${this.ui.mesAtual}`;
            },

            // --- Cálculos de Tempo ---
            timeToMin: function(timeStr) {
                if (!timeStr) return 0;
                const [h, m] = timeStr.split(':').map(Number);
                return (h * 60) + m;
            },

            minToTime: function(minutes) {
                const sign = minutes < 0 ? "-" : "";
                const absMin = Math.abs(minutes);
                const h = Math.floor(absMin / 60);
                const m = absMin % 60;
                return `${sign}${h}h ${m.toString().padStart(2, '0')}m`;
            },

            minToDecimal: function(minutes) {
                return (minutes / 60).toFixed(2);
            },

            isFeriado: function(dateStr, funcId = null) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario(funcId || this.data.config.funcionarioAtualId);
                return diasEspeciais.feriados.includes(dateStr);
            },
            
            isFolga: function(dateStr, funcId = null) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario(funcId || this.data.config.funcionarioAtualId);
                return diasEspeciais.folgas.includes(dateStr);
            },
            
            isAtestado: function(dateStr, funcId = null) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario(funcId || this.data.config.funcionarioAtualId);
                const checkDate = new Date(dateStr + 'T00:00:00'); 
                for(const atest of diasEspeciais.atestados) {
                    const start = new Date(atest.dataInicio + 'T00:00:00');
                    const end = new Date(start);
                    end.setDate(start.getDate() + atest.dias - 1); 
                    if (checkDate >= start && checkDate <= end) {
                        return atest.horasPorDia * 60; 
                    }
                }
                return 0; 
            },

            // Nova função para calcular horas extras em sábados considerando expediente
            calcularHorasExtrasSabado: function(reg, jornadaSabado) {
                let totalMinutos = 0;
                
                // Calcula o tempo trabalhado no sábado
                if (reg.e1 && reg.s1) totalMinutos += (this.timeToMin(reg.s1) - this.timeToMin(reg.e1));
                if (reg.e2 && reg.s2) totalMinutos += (this.timeToMin(reg.s2) - this.timeToMin(reg.e2));
                
                return totalMinutos - (jornadaSabado * 60);
            },

            setupDates: function() {
                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const selMes = document.getElementById('selectMes');
                const selAno = document.getElementById('selectAno');
                
                const populate = (selM, selA) => {
                    selM.innerHTML = '';
                    meses.forEach((m, i) => {
                        selM.innerHTML += `<option value="${i}" ${i === this.ui.mesAtual ? 'selected' : ''}>${m}</option>`;
                    });
                    selA.innerHTML = '';
                    for(let y = this.ui.anoAtual - 2; y <= this.ui.anoAtual + 2; y++) {
                        selA.innerHTML += `<option value="${y}" ${y === this.ui.anoAtual ? 'selected' : ''}>${y}</option>`;
                    }
                }

                populate(selMes, selAno);

                selMes.onchange = (e) => { this.ui.mesAtual = parseInt(e.target.value); this.renderPonto(); this.renderBancoHoras(); };
                selAno.onchange = (e) => { this.ui.anoAtual = parseInt(e.target.value); this.renderPonto(); this.renderBancoHoras(); };
            },

            renderAll: function() {
                this.renderHeaderFuncionario();
                this.renderSidebar();
                this.renderPonto();
                this.renderListaFuncionarios();
                this.renderFeriados();
                this.renderFolgas();
                this.renderAtestados();
                this.renderConfigEmpresa();
                this.updateCurrentFuncName();
                this.renderBancoHoras();
                this.renderHistoricoBaixas();
                this.renderExpediente();
            },

            renderHeaderFuncionario: function() {
                const sel = document.getElementById('headerFuncionarioSelect');
                sel.innerHTML = '<option value="">Selecione um funcionário</option>';
                this.data.funcionarios.forEach(f => {
                    sel.innerHTML += `<option value="${f.id}" ${f.id === this.data.config.funcionarioAtualId ? 'selected' : ''}>${f.nome}</option>`;
                });
            },

            renderSidebar: function() {
                const atual = this.getFuncionarioAtual();
                if (atual) {
                    document.getElementById('sidebarNome').textContent = atual.nome;
                    document.getElementById('sidebarCargo').textContent = atual.cargo;
                    document.getElementById('sidebarStatus').textContent = 'Ativo';
                    document.getElementById('sidebarStatus').style.background = 'var(--success-color)';
                } else {
                    document.getElementById('sidebarNome').textContent = 'Nenhum funcionário';
                    document.getElementById('sidebarCargo').textContent = 'Selecione ou cadastre';
                    document.getElementById('sidebarStatus').textContent = 'Inativo';
                    document.getElementById('sidebarStatus').style.background = 'var(--gray-color)';
                }
            },

            updateCurrentFuncName: function() {
                const atual = this.getFuncionarioAtual();
                if (atual) {
                    document.getElementById('currentFuncName').textContent = atual.nome;
                } else {
                    document.getElementById('currentFuncName').textContent = 'Nenhum funcionário';
                }
            },

            renderConfigEmpresa: function() {
                document.getElementById('confEmpresaNome').value = this.data.empresa.nome;
                document.getElementById('confEmpresaCnpj').value = this.data.empresa.cnpj;
                document.getElementById('confEmpresaEndereco').value = this.data.empresa.endereco;
            },

            // --- Renderização do Ponto ---
            renderPonto: function() {
                const tbody = document.getElementById('tabelaPontoBody');
                tbody.innerHTML = '';
                
                const func = this.getFuncionarioAtual();
                if (!func) {
                    this.checkEmptyStates();
                    return;
                }
                
                const diasNoMes = new Date(this.ui.anoAtual, this.ui.mesAtual + 1, 0).getDate();
                const key = this.getKeyRegistro();
                const registrosMes = this.data.registros[key] || {};
                
                for (let d = 1; d <= diasNoMes; d++) {
                    const dataObj = new Date(this.ui.anoAtual, this.ui.mesAtual, d);
                    const diaSemana = dataObj.getDay(); 
                    const isDomingo = diaSemana === 0;
                    
                    const y = dataObj.getFullYear();
                    const m = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                    const dd = d.toString().padStart(2, '0');
                    const dataFormatada = `${y}-${m}-${dd}`;
                    const isFeriado = this.isFeriado(dataFormatada);
                    const isFolga = this.isFolga(dataFormatada);

                    const reg = registrosMes[d] || {};
                    const calculo = this.calcularDiaComExpediente(reg, func.jornada, dataObj);
                    const isAtestadoDay = calculo.isAtestadoDay;

                    const diaNome = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][diaSemana];
                    
                    let rowClass = '';
                    if (isDomingo) rowClass = 'row-domingo';
                    if (isFeriado) rowClass = 'row-feriado';
                    if (isFolga) rowClass = 'row-folga';
                    if (isAtestadoDay) rowClass = 'row-atestado';

                    const diaExtraInfo = isFeriado ? '<i class="fas fa-star" style="font-size:10px; color:var(--special-color)"></i>' : 
                                      isFolga ? '<i class="fas fa-umbrella-beach" style="font-size:10px; color:#ff8f00"></i>' : 
                                      isAtestadoDay ? '<i class="fas fa-notes-medical" style="font-size:10px; color:#1890ff"></i>' : '';

                    const html = `
                        <tr class="${rowClass}" id="row-day-${d}">
                            <td><strong>${d.toString().padStart(2,'0')}</strong></td>
                            <td>${diaNome} ${diaExtraInfo}</td>
                            <td><input type="time" class="time-input" onchange="App.updatePonto(${d}, 'e1', this.value)" value="${reg.e1 || ''}"></td>
                            <td><input type="time" class="time-input" onchange="App.updatePonto(${d}, 's1', this.value)" value="${reg.s1 || ''}"></td>
                            <td><input type="time" class="time-input" onchange="App.updatePonto(${d}, 'e2', this.value)" value="${reg.e2 || ''}"></td>
                            <td><input type="time" class="time-input" onchange="App.updatePonto(${d}, 's2', this.value)" value="${reg.s2 || ''}"></td>
                            <td class="col-total">${this.minToTime(calculo.trabalhado)}</td>
                            <td class="col-saldo ${calculo.saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(calculo.saldo)}</td>
                            <td style="font-size: 12px; color: #666;">${calculo.observacao || ''}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', html);
                }
                this.updateDashboardTotals();
            },

            updatePonto: function(dia, campo, valor) {
                const key = this.getKeyRegistro();
                if (!this.data.registros[key]) this.data.registros[key] = {};
                if (!this.data.registros[key][dia]) this.data.registros[key][dia] = {};
                
                this.data.registros[key][dia][campo] = valor;
                this.saveToStorage();
                
                this.updateRowVisuals(dia);
                this.updateDashboardTotals();
                this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
            },

            updateRowVisuals: function(dia) {
                const row = document.getElementById(`row-day-${dia}`);
                if(!row) return;

                const func = this.getFuncionarioAtual();
                const dataObj = new Date(this.ui.anoAtual, this.ui.mesAtual, dia);
                const key = this.getKeyRegistro();
                const reg = this.data.registros[key][dia] || {};
                
                const calculo = this.calcularDiaComExpediente(reg, func.jornada, dataObj);
                
                const colTotal = row.querySelector('.col-total');
                const colSaldo = row.querySelector('.col-saldo');
                const colObservacao = row.querySelector('td:last-child');
                
                if(colTotal) colTotal.textContent = this.minToTime(calculo.trabalhado);
                if(colSaldo) {
                    colSaldo.textContent = this.minToTime(calculo.saldo);
                    colSaldo.className = `col-saldo ${calculo.saldo >= 0 ? 'saldo-positivo' : 'saldo-negativo'}`;
                }
                if(colObservacao) {
                    colObservacao.textContent = calculo.observacao || '';
                }
            },

            updateDashboardTotals: function() {
                const func = this.getFuncionarioAtual();
                if (!func) return;
                
                const diasNoMes = new Date(this.ui.anoAtual, this.ui.mesAtual + 1, 0).getDate();
                const key = this.getKeyRegistro();
                const registrosMes = this.data.registros[key] || {};
                
                let somaTrabalhada = 0;
                let somaSaldoMes = 0;

                for (let d = 1; d <= diasNoMes; d++) {
                    const dataObj = new Date(this.ui.anoAtual, this.ui.mesAtual, d);
                    const reg = registrosMes[d] || {};
                    const calculo = this.calcularDiaComExpediente(reg, func.jornada, dataObj);

                    const diaSemana = dataObj.getDay();
                    const isDomingo = diaSemana === 0;
                    const y = dataObj.getFullYear();
                    const m = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                    const dd = d.toString().padStart(2, '0');
                    const isFeriado = this.isFeriado(`${y}-${m}-${dd}`);
                    const isFolga = this.isFolga(`${y}-${m}-${dd}`);

                    if (calculo.teveBatida || calculo.isAtestadoDay || (!isDomingo && !isFeriado && !isFolga)) { 
                         somaTrabalhada += calculo.trabalhado;
                         somaSaldoMes += calculo.saldo;
                    }
                }

                // Calcula banco de horas (que agora inclui automaticamente todos os meses)
                const bancoHoras = this.calcularBancoHorasFuncionario();
                const saldoTotal = bancoHoras + somaSaldoMes;

                document.getElementById('resumoTrabalhadas').textContent = this.minToTime(somaTrabalhada);
                document.getElementById('resumoExtras').textContent = somaSaldoMes > 0 ? this.minToTime(somaSaldoMes) : '0h 00m';
                document.getElementById('resumoBanco').textContent = this.minToTime(bancoHoras);
                const elSaldo = document.getElementById('resumoSaldo');
                elSaldo.textContent = this.minToTime(saldoTotal);
                elSaldo.style.color = saldoTotal >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
            },

            // --- Banco de Horas ---
            renderBancoHoras: function() {
                const tbody = document.getElementById('tabelaBancoHorasBody');
                tbody.innerHTML = '';
                
                const func = this.getFuncionarioAtual();
                if (!func) return;
                
                // Obtém todos os meses com registros para este funcionário
                const mesesRegistrados = [];
                const chavesRegistros = Object.keys(this.data.registros);
                
                for (const chave of chavesRegistros) {
                    if (chave.startsWith(`${func.id}_`)) {
                        const [_, ano, mes] = chave.split('_');
                        mesesRegistrados.push({ano: parseInt(ano), mes: parseInt(mes)});
                    }
                }
                
                // Ordena por ano e mês
                mesesRegistrados.sort((a, b) => {
                    if (a.ano !== b.ano) return a.ano - b.ano;
                    return a.mes - b.mes;
                });
                
                let bancoAcumulado = 0;
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                for (const {ano, mes} of mesesRegistrados) {
                    const saldoMes = this.calcularSaldoMes(func.id, ano, mes);
                    const bancoAnterior = bancoAcumulado;
                    bancoAcumulado += saldoMes;
                    
                    const html = `
                        <tr>
                            <td><strong>${meses[mes]}/${ano}</strong></td>
                            <td class="${saldoMes >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(saldoMes)}</td>
                            <td>${this.minToTime(bancoAnterior)}</td>
                            <td class="${bancoAcumulado >= 0 ? 'saldo-positivo' : 'saldo-negativo'}"><strong>${this.minToTime(bancoAcumulado)}</strong></td>
                            <td>
                                <span class="status-badge" style="background: ${bancoAcumulado >= 0 ? '#4cc9f0' : '#f94144'}; color: white;">
                                    ${bancoAcumulado >= 0 ? 'CRÉDITO' : 'DÉBITO'}
                                </span>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', html);
                }
                
                // Adiciona linha de total de baixas
                const baixas = this.data.baixasBancoHoras[func.id] || [];
                const totalBaixas = baixas.reduce((total, baixa) => total + baixa.horas, 0);
                
                if (totalBaixas > 0) {
                    const saldoFinal = bancoAcumulado - totalBaixas;
                    
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                            <td colspan="3" style="text-align: right;">Total de Baixas:</td>
                            <td class="saldo-negativo">-${this.minToTime(totalBaixas)}</td>
                            <td></td>
                        </tr>
                        <tr style="background-color: #e9ecef; font-weight: bold;">
                            <td colspan="3" style="text-align: right;">Saldo Final (Após Baixas):</td>
                            <td class="${saldoFinal >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(saldoFinal)}</td>
                            <td>
                                <span class="status-badge" style="background: ${saldoFinal >= 0 ? '#4cc9f0' : '#f94144'}; color: white;">
                                    ${saldoFinal >= 0 ? 'CRÉDITO' : 'DÉBITO'}
                                </span>
                            </td>
                        </tr>
                    `);
                } else if (mesesRegistrados.length > 0) {
                    // Se não há baixas, mas há meses registrados, mostra o saldo final
                    tbody.insertAdjacentHTML('beforeend', `
                        <tr style="background-color: #e9ecef; font-weight: bold;">
                            <td colspan="3" style="text-align: right;">Saldo Final:</td>
                            <td class="${bancoAcumulado >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(bancoAcumulado)}</td>
                            <td>
                                <span class="status-badge" style="background: ${bancoAcumulado >= 0 ? '#4cc9f0' : '#f94144'}; color: white;">
                                    ${bancoAcumulado >= 0 ? 'CRÉDITO' : 'DÉBITO'}
                                </span>
                            </td>
                        </tr>
                    `);
                } else {
                    // Se não há registros
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; color: #666; padding: 40px;">
                                <i class="fas fa-database" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                <h4>Nenhum registro encontrado</h4>
                                <p>Registre pontos para ver o histórico do banco de horas</p>
                            </td>
                        </tr>
                    `;
                }
                
                // Atualiza o cache do banco de horas
                const saldoFinal = baixas.length > 0 ? bancoAcumulado - totalBaixas : bancoAcumulado;
                this.data.bancoHoras[func.id] = saldoFinal;
            },

            renderFeriados: function() {
                const list = document.getElementById('listaFeriados');
                list.innerHTML = '';
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.feriados.sort().forEach(dateStr => {
                    const [y, m, d] = dateStr.split('-');
                    const display = `${d}/${m}/${y}`;
                    list.innerHTML += `<div class="tag">${display} <i class="fas fa-times" onclick="App.removerFeriado('${dateStr}')"></i></div>`;
                });
            },

            renderFolgas: function() {
                const list = document.getElementById('listaFolgas');
                list.innerHTML = '';
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.folgas.sort().forEach(dateStr => {
                    const [y, m, d] = dateStr.split('-');
                    const display = `${d}/${m}/${y}`;
                    list.innerHTML += `<div class="tag" style="background:#fff8e1;">${display} <i class="fas fa-times" onclick="App.removerFolga('${dateStr}')"></i></div>`;
                });
            },

            adicionarFeriado: function() {
                const data = document.getElementById('inputFeriadoData').value;
                if(!data) return showToast('Selecione uma data', 'error');
                
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                
                if(!diasEspeciais.feriados.includes(data)) {
                    diasEspeciais.feriados.push(data);
                    this.saveToStorage();
                    this.renderFeriados();
                    this.renderPonto();
                    this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
                    showToast('Feriado adicionado!', 'success');
                }
            },

            removerFeriado: function(dateStr) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.feriados = diasEspeciais.feriados.filter(d => d !== dateStr);
                this.saveToStorage();
                this.renderFeriados();
                this.renderPonto();
                this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
            },

            adicionarFolga: function() {
                const data = document.getElementById('inputFolgaData').value;
                if(!data) return showToast('Selecione uma data', 'error');
                
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                
                if(!diasEspeciais.folgas.includes(data)) {
                    diasEspeciais.folgas.push(data);
                    this.saveToStorage();
                    this.renderFolgas();
                    this.renderPonto();
                    this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
                    showToast('Folga adicionada!', 'success');
                }
            },

            removerFolga: function(dateStr) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.folgas = diasEspeciais.folgas.filter(d => d !== dateStr);
                this.saveToStorage();
                this.renderFolgas();
                this.renderPonto();
                this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
            },
            
            renderAtestados: function() {
                const list = document.getElementById('listaAtestados');
                list.innerHTML = '';
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.atestados.sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio)).forEach(atest => {
                    const [y, m, d] = atest.dataInicio.split('-');
                    const display = `${d}/${m}/${y} | ${atest.dias} dias (${atest.horasPorDia}h/dia)`;
                    list.innerHTML += `<div class="tag" style="background:#e6f7ff;">${display} <i class="fas fa-times" onclick="App.removerAtestado('${atest.dataInicio}', ${atest.dias})"></i></div>`;
                });
            },

            adicionarAtestado: function() {
                const dataInicio = document.getElementById('inputAtestadoData').value;
                const dias = parseInt(document.getElementById('inputAtestadoDias').value);
                const horasPorDia = parseInt(document.getElementById('inputAtestadoHoras').value);

                if(!dataInicio || dias <= 0 || horasPorDia <= 0) return showToast('Preencha os dados do atestado corretamente', 'error');
                
                const novoAtestado = { dataInicio, dias, horasPorDia };
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                
                const isDuplicate = diasEspeciais.atestados.some(a => a.dataInicio === dataInicio && a.dias === dias && a.horasPorDia === horasPorDia);

                if(!isDuplicate) {
                    diasEspeciais.atestados.push(novoAtestado);
                    this.saveToStorage();
                    this.renderAtestados();
                    this.renderPonto();
                    this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
                    showToast('Atestado adicionado!', 'success');
                } else {
                    showToast('Atestado já cadastrado para esta data/período.', 'warning');
                }
            },

            removerAtestado: function(dataInicio, dias) {
                const diasEspeciais = this.getDiasEspeciaisFuncionario();
                diasEspeciais.atestados = diasEspeciais.atestados.filter(a => !(a.dataInicio === dataInicio && a.dias === dias));
                this.saveToStorage();
                this.renderAtestados();
                this.renderPonto();
                this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
            },

            processarImportacao: function(mes, ano) {
                const file = this.ui.arquivoParaImportar;
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                        if (jsonData.length < 2) throw new Error("Arquivo inválido");

                        let count = 0;
                        const key = `${this.data.config.funcionarioAtualId}_${ano}_${mes}`;
                        if (!this.data.registros[key]) this.data.registros[key] = {};

                        const fmtTime = (val) => {
                            if (!val) return "";
                            if (typeof val === 'string') return val.trim().substr(0, 5);
                            if (typeof val === 'number') {
                                const totalMinutes = Math.round(val * 24 * 60);
                                const h = Math.floor(totalMinutes / 60) % 24;
                                const m = totalMinutes % 60;
                                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                            }
                            return "";
                        };

                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row[0]) continue;

                            let dia = null;
                            if (typeof row[0] === 'number') {
                                if (row[0] >= 1 && row[0] <= 31) dia = row[0];
                                else {
                                    const jsDate = XLSX.SSF.parse_date_code(row[0]);
                                    if(jsDate) dia = jsDate.d;
                                }
                            } else if (typeof row[0] === 'string') {
                                const parts = row[0].match(/(\d{1,2})/);
                                if (parts) dia = parseInt(parts[0]);
                            }

                            if (dia && dia >= 1 && dia <= 31) {
                                this.data.registros[key][dia] = {
                                    e1: fmtTime(row[1]),
                                    s1: fmtTime(row[2]),
                                    e2: fmtTime(row[3]),
                                    s2: fmtTime(row[4])
                                };
                                count++;
                            }
                        }

                        this.saveToStorage();
                        this.ui.mesAtual = parseInt(mes);
                        this.ui.anoAtual = parseInt(ano);
                        document.getElementById('selectMes').value = mes;
                        document.getElementById('selectAno').value = ano;
                        
                        this.renderPonto();
                        this.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
                        fecharModalImportacao();
                        showToast(`${count} registros importados em ${mes+1}/${ano}!`, 'success');
                        navegar('ponto', document.querySelector('a[onclick*="ponto"]'));

                    } catch (err) {
                        console.error(err);
                        showToast("Erro no arquivo. Verifique o formato.", "error");
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            renderListaFuncionarios: function() {
                const container = document.getElementById('listaFuncionariosGrid');
                container.innerHTML = '';
                this.data.funcionarios.forEach(f => {
                    const banco = this.calcularBancoHorasFuncionario(f.id);
                    const card = `
                        <div class="card" style="border-left: 5px solid ${f.id === this.data.config.funcionarioAtualId ? 'var(--success-color)' : 'var(--gray-color)'}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>${f.nome}</h3>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <span class="status-badge" style="background: ${f.bancoHorasAtivo ? 'var(--success-color)' : 'var(--danger-color)'}; color: white;">
                                        ${f.bancoHorasAtivo ? 'Banco Ativo' : 'Banco Inativo'}
                                    </span>
                                    ${f.id !== this.data.config.funcionarioAtualId ? `<button class="btn btn-danger" style="padding:5px 10px; font-size:12px;" onclick="App.removerFuncionario('${f.id}')"><i class="fas fa-trash"></i></button>` : '<span class="status-badge" style="background:var(--success-color); color:white;">Ativo</span>'}
                                </div>
                            </div>
                            <p style="color:#666; margin-top:5px;">${f.cargo} | Matrícula: ${f.codigo}</p>
                            <p style="margin-top:10px; font-size:14px;">
                                <i class="fas fa-piggy-bank"></i> Banco de Horas: 
                                <span class="${banco >= 0 ? 'saldo-positivo' : 'saldo-negativo'}">${this.minToTime(banco)}</span>
                            </p>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary" style="flex:1;" onclick="trocarFuncionario('${f.id}')">Selecionar</button>
                                <button class="btn ${f.bancoHorasAtivo ? 'btn-warning' : 'btn-success'}" style="flex:1;" onclick="App.toggleBancoHorasFuncionario('${f.id}')">
                                    ${f.bancoHorasAtivo ? 'Desativar Banco' : 'Ativar Banco'}
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
            },

            removerFuncionario: function(id) {
                if (confirm('Tem certeza? Isso apagará o cadastro, registros e banco de horas deste funcionário.')) {
                    this.data.funcionarios = this.data.funcionarios.filter(f => f.id !== id);
                    // Remove também os dias especiais, banco de horas e expediente deste funcionário
                    delete this.data.diasEspeciais[id];
                    delete this.data.bancoHoras[id];
                    delete this.data.historicoBancoHoras[id];
                    delete this.data.baixasBancoHoras[id];
                    delete this.data.expediente[id];
                    
                    // Remove registros deste funcionário
                    const chavesParaRemover = Object.keys(this.data.registros).filter(chave => chave.startsWith(`${id}_`));
                    chavesParaRemover.forEach(chave => delete this.data.registros[chave]);
                    
                    this.saveToStorage();
                    this.renderAll();
                    this.atualizarResumoSaldos();
                    this.atualizarSelectFuncionariosPeriodo();
                    showToast('Funcionário removido', 'success');
                }
            },

            setupClock: function() {
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('currentDate').textContent = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                    document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-BR');
                }, 1000);
            },

            // --- Métodos para recibo de horas extras ---
            calcularHorasExtrasMes: function() {
                const func = this.getFuncionarioAtual();
                const key = this.getKeyRegistro();
                const registrosMes = this.data.registros[key] || {};
                const diasNoMes = new Date(this.ui.anoAtual, this.ui.mesAtual + 1, 0).getDate();
                
                let horasExtrasNormais = 0; // 50%
                let horasExtrasFeriado = 0; // 100%
                let horasExtrasDomingo = 0; // 100%
                let horasExtrasFolga = 0; // 100%
                
                for (let d = 1; d <= diasNoMes; d++) {
                    const dataObj = new Date(this.ui.anoAtual, this.ui.mesAtual, d);
                    const reg = registrosMes[d] || {};
                    const calculo = this.calcularDiaComExpediente(reg, func.jornada, dataObj);
                    
                    if (calculo.saldo > 0) {
                        const y = dataObj.getFullYear();
                        const m = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                        const dd = d.toString().padStart(2, '0');
                        const dataFormatada = `${y}-${m}-${dd}`;
                        
                        if (calculo.isFeriado) {
                            horasExtrasFeriado += calculo.saldo;
                        } else if (calculo.isDomingo) {
                            horasExtrasDomingo += calculo.saldo;
                        } else if (calculo.isFolga) {
                            horasExtrasFolga += calculo.saldo;
                        } else {
                            horasExtrasNormais += calculo.saldo;
                        }
                    }
                }
                
                return {
                    normais: horasExtrasNormais,
                    feriado: horasExtrasFeriado,
                    domingo: horasExtrasDomingo,
                    folga: horasExtrasFolga,
                    total: horasExtrasNormais + horasExtrasFeriado + horasExtrasDomingo + horasExtrasFolga
                };
            },

            // --- Obter histórico de banco de horas por funcionário ---
            getHistoricoBancoHorasFuncionario: function(funcId) {
                const historico = this.data.historicoBancoHoras[funcId] || {};
                const meses = Object.keys(historico);
                
                return meses.map(chave => {
                    const item = historico[chave];
                    return {
                        ano: item.ano,
                        mes: item.mes,
                        saldoMes: item.saldoMes,
                        dataRegistro: item.dataRegistro
                    };
                }).sort((a, b) => {
                    if (a.ano !== b.ano) return a.ano - b.ano;
                    return a.mes - b.mes;
                });
            },

            // --- Obter saldo total por período ---
            getSaldoTotalPorPeriodo: function(funcId, dataInicial, dataFinal) {
                if (!funcId) return 0;
                
                const dataIni = new Date(dataInicial);
                const dataFim = new Date(dataFinal);
                
                let saldoTotal = 0;
                const chavesRegistros = Object.keys(this.data.registros);
                
                for (const chave of chavesRegistros) {
                    if (chave.startsWith(`${funcId}_`)) {
                        const [_, ano, mes] = chave.split('_');
                        const dataMes = new Date(parseInt(ano), parseInt(mes), 1);
                        
                        // Verifica se o mês está dentro do período
                        if (dataMes >= dataIni && dataMes <= dataFim) {
                            const saldoMes = this.calcularSaldoMes(funcId, parseInt(ano), parseInt(mes));
                            saldoTotal += saldoMes;
                        }
                    }
                }
                
                return saldoTotal;
            },

            // --- Obter detalhes do período para relatório consolidado ---
            getDetalhesPeriodoConsolidado: function(dataInicial, dataFinal, funcId = null) {
                const dataIni = new Date(dataInicial);
                const dataFim = new Date(dataFinal);
                
                const resultado = {
                    funcionarios: [],
                    periodo: {
                        dataInicial: dataIni.toLocaleDateString('pt-BR'),
                        dataFinal: dataFim.toLocaleDateString('pt-BR'),
                        meses: []
                    },
                    totais: {
                        saldoTotal: 0,
                        horasExtras: 0,
                        horasFaltantes: 0,
                        funcionariosAnalisados: 0
                    }
                };
                
                // Determinar quais funcionários analisar
                const funcionariosAnalisar = funcId && funcId !== 'todos' 
                    ? this.data.funcionarios.filter(f => f.id === funcId)
                    : this.data.funcionarios;
                
                resultado.totais.funcionariosAnalisados = funcionariosAnalisar.length;
                
                // Para cada funcionário, calcular o saldo no período
                funcionariosAnalisar.forEach(func => {
                    const saldoPeriodo = this.getSaldoTotalPorPeriodo(func.id, dataInicial, dataFinal);
                    
                    // Determinar status
                    let status = 'NEUTRO';
                    let statusCor = '#666';
                    if (saldoPeriodo > 0) {
                        status = 'CRÉDITO';
                        statusCor = '#4cc9f0';
                        resultado.totais.horasExtras += saldoPeriodo;
                    } else if (saldoPeriodo < 0) {
                        status = 'DÉBITO';
                        statusCor = '#f94144';
                        resultado.totais.horasFaltantes += Math.abs(saldoPeriodo);
                    }
                    
                    resultado.totais.saldoTotal += saldoPeriodo;
                    
                    resultado.funcionarios.push({
                        id: func.id,
                        nome: func.nome,
                        cargo: func.cargo,
                        codigo: func.codigo,
                        saldoPeriodo: saldoPeriodo,
                        saldoFormatado: this.minToTime(saldoPeriodo),
                        status: status,
                        statusCor: statusCor,
                        bancoAtivo: func.bancoHorasAtivo
                    });
                });
                
                // Calcular meses incluídos no período
                let dataAtual = new Date(dataIni);
                dataAtual.setDate(1); // Primeiro dia do mês
                
                while (dataAtual <= dataFim) {
                    const ano = dataAtual.getFullYear();
                    const mes = dataAtual.getMonth();
                    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    
                    resultado.periodo.meses.push({
                        ano: ano,
                        mes: mes,
                        mesNome: meses[mes]
                    });
                    
                    // Avançar para o próximo mês
                    dataAtual.setMonth(dataAtual.getMonth() + 1);
                }
                
                return resultado;
            }
        };

        // ==========================================
        // FUNÇÕES GLOBAIS / MODALS
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => App.init());

        function navegar(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if(element) element.classList.add('active');
            
            // Atualiza o nome do funcionário atual na tela de dias especiais
            if (sectionId === 'feriados') {
                App.updateCurrentFuncName();
            }
            
            // Atualiza o banco de horas se navegar para a seção
            if (sectionId === 'bancohoras') {
                App.renderBancoHoras();
                App.renderHistoricoBaixas();
            }
            
            // Atualiza o resumo de saldos se navegar para a seção
            if (sectionId === 'relatoriosaldominutos') {
                App.atualizarResumoSaldos();
            }
            
            // Atualiza expediente se navegar para a seção
            if (sectionId === 'expediente') {
                App.renderExpediente();
            }
            
            // Verifica estados vazios
            App.checkEmptyStates();
        }

        function showToast(msg, type = 'info') {
            const el = document.createElement('div');
            let color = '#4361ee';
            if(type === 'success') color = '#4cc9f0';
            if(type === 'error') color = '#f94144';
            
            el.style.cssText = `background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-left: 5px solid ${color}; font-weight: 500; animation: fadeIn 0.3s;`;
            el.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            document.getElementById('toastContainer').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function trocarFuncionario(id) {
            App.data.config.funcionarioAtualId = id;
            App.saveToStorage();
            App.renderAll();
            const func = App.getFuncionarioAtual();
            if (func) {
                showToast(`Perfil alterado para ${func.nome}`, 'success');
                // Atualiza a exibição do banco de horas
                App.atualizarExibicaoBancoHoras();
            }
        }

        function abrirModalFuncionario() { document.getElementById('modalFuncionario').classList.add('active'); }
        function fecharModalFuncionario() { document.getElementById('modalFuncionario').classList.remove('active'); }
        
        function abrirModalImportacao() { 
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const selMes = document.getElementById('importMesRef');
            const selAno = document.getElementById('importAnoRef');
            
            selMes.innerHTML = '';
            meses.forEach((m, i) => selMes.innerHTML += `<option value="${i}" ${i === App.ui.mesAtual ? 'selected' : ''}>${m}</option>`);
            
            selAno.innerHTML = '';
            for(let y = App.ui.anoAtual - 1; y <= App.ui.anoAtual + 1; y++) selAno.innerHTML += `<option value="${y}" ${y === App.ui.anoAtual ? 'selected' : ''}>${y}</option>`;

            document.getElementById('modalImportacao').classList.add('active'); 
        }
        function fecharModalImportacao() { document.getElementById('modalImportacao').classList.remove('active'); }

        function abrirModalBaixaBanco() {
            const select = document.getElementById('baixaFuncionario');
            select.innerHTML = '<option value="">Selecione um funcionário</option>';
            
            App.data.funcionarios.forEach(func => {
                if (func.bancoHorasAtivo) {
                    const saldo = App.calcularBancoHorasFuncionario(func.id);
                    if (saldo > 0) {
                        select.innerHTML += `<option value="${func.id}">${func.nome} (${App.minToTime(saldo)})</option>`;
                    }
                }
            });
            
            if (select.options.length <= 1) {
                showToast('Nenhum funcionário com saldo positivo no banco de horas', 'warning');
                return;
            }
            
            document.getElementById('modalBaixaBanco').classList.add('active');
        }

        function abrirModalPeriodoConsolidado() {
            document.getElementById('modalPeriodoConsolidado').classList.add('active');
        }
        
        function fecharModalPeriodoConsolidado() {
            document.getElementById('modalPeriodoConsolidado').classList.remove('active');
        }

        // Funções para Expediente
        function abrirModalExpediente() {
            const func = App.getFuncionarioAtual();
            if (!func) {
                showToast('Selecione um funcionário primeiro', 'error');
                return;
            }
            
            const expediente = App.getExpedienteFuncionario();
            const content = document.getElementById('expedienteContent');
            
            let html = `
                <h3 style="margin-bottom: 20px;">Configurar Expediente para ${func.nome}</h3>
                <p style="margin-bottom: 20px; color: #666;">Configure os horários de trabalho para cada dia da semana.</p>
                
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Dia</th>
                            <th>Trabalha?</th>
                            <th>Entrada 1</th>
                            <th>Saída 1</th>
                            <th>Entrada 2</th>
                            <th>Saída 2</th>
                            <th>Jornada (h)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const dias = [
                { chave: 'segunda', nome: 'Segunda' },
                { chave: 'terca', nome: 'Terça' },
                { chave: 'quarta', nome: 'Quarta' },
                { chave: 'quinta', nome: 'Quinta' },
                { chave: 'sexta', nome: 'Sexta' },
                { chave: 'sabado', nome: 'Sábado' },
                { chave: 'domingo', nome: 'Domingo' }
            ];
            
            dias.forEach(dia => {
                const config = expediente[dia.chave];
                html += `
                    <tr>
                        <td><strong>${dia.nome}</strong></td>
                        <td>
                            <input type="checkbox" id="exp_${dia.chave}_trab" ${config.trab ? 'checked' : ''} 
                                   onchange="atualizarJornadaExpediente('${dia.chave}')">
                        </td>
                        <td><input type="time" id="exp_${dia.chave}_e1" value="${config.e1 || ''}" class="form-control" style="margin: 0; padding: 8px;"></td>
                        <td><input type="time" id="exp_${dia.chave}_s1" value="${config.s1 || ''}" class="form-control" style="margin: 0; padding: 8px;"></td>
                        <td><input type="time" id="exp_${dia.chave}_e2" value="${config.e2 || ''}" class="form-control" style="margin: 0; padding: 8px;"></td>
                        <td><input type="time" id="exp_${dia.chave}_s2" value="${config.s2 || ''}" class="form-control" style="margin: 0; padding: 8px;"></td>
                        <td><input type="number" id="exp_${dia.chave}_jornada" value="${config.jornada}" min="0" max="24" step="0.5" class="form-control" style="margin: 0; padding: 8px;"></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p><strong>Observações:</strong></p>
                    <ul style="margin-top: 10px; color: #666; padding-left: 20px;">
                        <li>Para sábado, defina a jornada normalmente (ex: 4h)</li>
                        <li>Horas trabalhadas além da jornada configurada serão consideradas extras</li>
                        <li>Domingo sempre será 100% extra se trabalhado</li>
                        <li>Para dias não trabalhados, marque "Trabalha?" como não</li>
                    </ul>
                </div>
            `;
            
            content.innerHTML = html;
            document.getElementById('modalConfigExpediente').classList.add('active');
        }

        function fecharModalExpediente() {
            document.getElementById('modalConfigExpediente').classList.remove('active');
        }

        function atualizarJornadaExpediente(diaChave) {
            // Função para recalcular jornada com base nos horários
            const e1 = document.getElementById(`exp_${diaChave}_e1`).value;
            const s1 = document.getElementById(`exp_${diaChave}_s1`).value;
            const e2 = document.getElementById(`exp_${diaChave}_e2`).value;
            const s2 = document.getElementById(`exp_${diaChave}_s2`).value;
            
            let jornada = 0;
            
            if (e1 && s1) {
                const minutosE1 = App.timeToMin(e1);
                const minutosS1 = App.timeToMin(s1);
                if (minutosS1 > minutosE1) {
                    jornada += (minutosS1 - minutosE1) / 60;
                }
            }
            
            if (e2 && s2) {
                const minutosE2 = App.timeToMin(e2);
                const minutosS2 = App.timeToMin(s2);
                if (minutosS2 > minutosE2) {
                    jornada += (minutosS2 - minutosE2) / 60;
                }
            }
            
            // Arredonda para 0.5
            jornada = Math.round(jornada * 2) / 2;
            
            document.getElementById(`exp_${diaChave}_jornada`).value = jornada;
        }

        function salvarExpediente() {
            const func = App.getFuncionarioAtual();
            if (!func) return;
            
            const expediente = {};
            const dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado', 'domingo'];
            
            dias.forEach(dia => {
                const trab = document.getElementById(`exp_${dia}_trab`).checked;
                const e1 = document.getElementById(`exp_${dia}_e1`).value || null;
                const s1 = document.getElementById(`exp_${dia}_s1`).value || null;
                const e2 = document.getElementById(`exp_${dia}_e2`).value || null;
                const s2 = document.getElementById(`exp_${dia}_s2`).value || null;
                const jornada = parseFloat(document.getElementById(`exp_${dia}_jornada`).value) || 0;
                
                expediente[dia] = {
                    trab: trab,
                    e1: e1,
                    s1: s1,
                    e2: e2,
                    s2: s2,
                    jornada: jornada
                };
            });
            
            App.salvarExpedienteFuncionario(func.id, expediente);
            fecharModalExpediente();
        }

        function atualizarSaldoBaixa() {
            const funcId = document.getElementById('baixaFuncionario').value;
            if (!funcId) {
                document.getElementById('baixaSaldoDisponivel').value = '';
                return;
            }
            
            const saldo = App.calcularBancoHorasFuncionario(funcId);
            document.getElementById('baixaSaldoDisponivel').value = App.minToTime(saldo);
        }

        function confirmarBaixaBanco() {
            const funcId = document.getElementById('baixaFuncionario').value;
            const horas = parseInt(document.getElementById('baixaHoras').value);
            const tipo = document.getElementById('baixaTipo').value;
            const observacao = document.getElementById('baixaObservacao').value;
            
            if (!funcId || !horas || horas <= 0) {
                showToast('Preencha todos os campos corretamente', 'error');
                return;
            }
            
            const sucesso = App.registrarBaixaBancoHoras(funcId, horas, tipo, observacao);
            if (sucesso) {
                cancelarBaixaBanco();
            }
        }

        function cancelarBaixaBanco() {
            document.getElementById('modalBaixaBanco').classList.remove('active');
            document.getElementById('baixaFuncionario').value = '';
            document.getElementById('baixaHoras').value = '';
            document.getElementById('baixaTipo').value = 'pagamento';
            document.getElementById('baixaObservacao').value = '';
            document.getElementById('baixaSaldoDisponivel').value = '';
        }

        function salvarFuncionarioModal() {
            const nome = document.getElementById('funcNome').value;
            const cargo = document.getElementById('funcCargo').value;
            const codigo = document.getElementById('funcCodigo').value;
            const jornada = document.getElementById('funcJornada').value;
            const bancoHorasAtivo = document.getElementById('funcBancoHorasAtivo').checked;

            if (!nome || !cargo) return showToast('Preencha os campos obrigatórios', 'error');

            App.addFuncionario(nome, cargo, codigo, jornada, bancoHorasAtivo);
            fecharModalFuncionario();
            App.renderAll();
            showToast('Funcionário cadastrado!', 'success');
        }

        function salvarConfigEmpresa() {
            App.data.empresa.nome = document.getElementById('confEmpresaNome').value;
            App.data.empresa.cnpj = document.getElementById('confEmpresaCnpj').value;
            App.data.empresa.endereco = document.getElementById('confEmpresaEndereco').value;
            App.saveToStorage();
            showToast('Dados da empresa atualizados', 'success');
        }

        function salvarPontoAtual() {
            App.saveToStorage();
            App.atualizarBancoHoras(); // Atualiza automaticamente o banco de horas
            showToast('Dados salvos com sucesso', 'success');
        }

        function prepararArquivo(input) {
            if(input.files && input.files[0]) {
                App.ui.arquivoParaImportar = input.files[0];
                document.getElementById('importFileName').textContent = input.files[0].name;
            }
        }

        function executarImportacao() {
            if(!App.ui.arquivoParaImportar) return showToast('Selecione um arquivo primeiro', 'error');
            const mes = document.getElementById('importMesRef').value;
            const ano = document.getElementById('importAnoRef').value;
            App.processarImportacao(parseInt(mes), parseInt(ano));
        }

        // --- Funções de Backup Automático ---
        function continuarSistema() {
            document.getElementById('modalBackupAuto').classList.remove('active');
            App.ui.ultimaAtividade = Date.now();
            App.fazerBackupAutomatico();
        }

        function sairComBackup() {
            App.fazerBackupAutomatico();
            App.ui.fechamentoBloqueado = false;
            setTimeout(() => {
                window.close();
                showToast('Sistema encerrado com backup realizado', 'success');
            }, 1000);
        }

        function mostrarModalFechamento() {
            document.getElementById('modalFechamento').classList.add('active');
        }

        function fecharComBackup() {
            App.fazerBackupAutomatico();
            App.ui.fechamentoBloqueado = false;
            setTimeout(() => {
                window.close();
            }, 1000);
        }

        function cancelarFechamento() {
            document.getElementById('modalFechamento').classList.remove('active');
        }

        // ==========================================
        // FUNÇÕES PARA RELATÓRIOS DE SALDO DE HORAS
        // ==========================================

        function gerarRelatorioSaldosGeral() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const azulPrincipal = [67, 97, 238];
            const verde = [76, 201, 240];
            const vermelho = [249, 65, 68];
            
            // Cabeçalho
            doc.setFillColor(...azulPrincipal);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("RELATÓRIO DE SALDO DE HORAS - GERAL", 105, 18, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 26, { align: "center" });
            doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 105, 32, { align: "center" });
            
            // Tabela de funcionários
            let yPos = 50;
            
            const tableData = [];
            let saldoTotalEmpresa = 0;
            
            // Cabeçalho
            tableData.push([
                { content: 'Funcionário', styles: { fontStyle: 'bold' } },
                { content: 'Cargo', styles: { fontStyle: 'bold' } },
                { content: 'Matrícula', styles: { fontStyle: 'bold' } },
                { content: 'Saldo Banco de Horas', styles: { fontStyle: 'bold' } },
                { content: 'Status', styles: { fontStyle: 'bold' } },
                { content: 'Banco Ativo', styles: { fontStyle: 'bold' } }
            ]);
            
            // Dados
            App.data.funcionarios.forEach(func => {
                const banco = App.calcularBancoHorasFuncionario(func.id);
                saldoTotalEmpresa += banco;
                
                const status = banco >= 0 ? 'Crédito' : 'Débito';
                
                tableData.push([
                    func.nome,
                    func.cargo,
                    func.codigo,
                    { content: App.minToTime(banco), styles: { textColor: banco >= 0 ? [0, 150, 0] : [200, 50, 50] } },
                    status,
                    func.bancoHorasAtivo ? 'Sim' : 'Não'
                ]);
            });
            
            // Rodapé com total
            tableData.push([
                { content: 'TOTAL GERAL', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                { content: App.minToTime(saldoTotalEmpresa), styles: { fontStyle: 'bold', textColor: saldoTotalEmpresa >= 0 ? [0, 150, 0] : [200, 50, 50] } },
                { content: '', styles: { fontStyle: 'bold' } }
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [tableData[0]],
                body: tableData.slice(1, -1),
                foot: [tableData[tableData.length - 1]],
                theme: 'grid',
                headStyles: { fillColor: azulPrincipal, textColor: 255, fontStyle: 'bold', halign: 'center' },
                footStyles: { fillColor: [240, 240, 240], textColor: [50, 50, 50], fontStyle: 'bold' },
                bodyStyles: { halign: 'center' },
                alternateRowStyles: { fillColor: [248, 249, 252] },
                styles: { fontSize: 9, cellPadding: 5 },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 }
                }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            // Resumo
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("RESUMO:", 20, yPos);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Total de Funcionários: ${App.data.funcionarios.length}`, 20, yPos + 8);
            
            const funcionariosCredito = App.data.funcionarios.filter(f => App.calcularBancoHorasFuncionario(f.id) >= 0).length;
            const funcionariosDebito = App.data.funcionarios.filter(f => App.calcularBancoHorasFuncionario(f.id) < 0).length;
            const funcionariosBancoAtivo = App.data.funcionarios.filter(f => f.bancoHorasAtivo).length;
            
            doc.text(`Funcionários com Crédito: ${funcionariosCredito}`, 20, yPos + 16);
            doc.text(`Funcionários com Débito: ${funcionariosDebito}`, 20, yPos + 24);
            doc.text(`Funcionários com Banco Ativo: ${funcionariosBancoAtivo}`, 20, yPos + 32);
            
            // Observações
            yPos += 45;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("OBSERVAÇÕES:", 20, yPos);
            
            doc.setFont("helvetica", "normal");
            const observacoes = [
                "1. Saldo positivo indica horas extras trabalhadas (crédito).",
                "2. Saldo negativo indica horas a compensar (débito).",
                "3. Este relatório reflete o banco de horas acumulado de todos os meses.",
                "4. O banco de horas é atualizado automaticamente a cada alteração no ponto.",
                "5. Quando o Banco de Horas está inativo, o saldo é zerado e não há acúmulo.",
                "6. Saldo líquido: positivo e negativo se compensam automaticamente (ex: 30min extra + 30min faltante = 0)"
            ];
            
            observacoes.forEach((obs, index) => {
                doc.text(obs, 25, yPos + 7 + (index * 5));
            });
            
            // Rodapé
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Relatório gerado automaticamente por Ponto Enterprise System", 105, 285, { align: "center" });
            
            // Salvar
            const date = new Date().toISOString().slice(0, 10);
            doc.save(`Relatorio_Saldos_Geral_${date}.pdf`);
            showToast('Relatório geral de saldos gerado com sucesso!', 'success');
        }

        function gerarRelatorioSaldoFuncionario() {
            const func = App.getFuncionarioAtual();
            if (!func) {
                showToast('Selecione um funcionário primeiro', 'error');
                return;
            }
            gerarRelatorioSaldoFuncionarioEspecifico(func.id);
        }

        function gerarRelatorioSaldoFuncionarioEspecifico(funcId) {
            const func = App.data.funcionarios.find(f => f.id === funcId);
            if (!func) {
                showToast('Funcionário não encontrado', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const azulPrincipal = [67, 97, 238];
            const verde = [76, 201, 240];
            const vermelho = [249, 65, 68];
            
            // Cabeçalho
            doc.setFillColor(...azulPrincipal);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("RELATÓRIO DE SALDO DE HORAS", 105, 18, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 26, { align: "center" });
            doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 105, 32, { align: "center" });
            
            // Informações do funcionário
            doc.setFillColor(245, 247, 250);
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(14, 45, 182, 25, 3, 3, 'FD');
            
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("FUNCIONÁRIO:", 20, 55);
            doc.text("CARGO:", 120, 55);
            doc.text("MATRÍCULA:", 20, 65);
            doc.text("JORNADA DIÁRIA:", 120, 65);
            
            doc.setFont("helvetica", "normal");
            doc.text(func.nome.toUpperCase(), 45, 55);
            doc.text(func.cargo.toUpperCase(), 140, 55);
            doc.text(func.codigo, 45, 65);
            doc.text(`${func.jornada} HORAS`, 140, 65);
            
            // Status do banco de horas
            const bancoAtivo = func.bancoHorasAtivo ? 'SIM' : 'NÃO';
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("BANCO DE HORAS ATIVO:", 20, 75);
            doc.setFont("helvetica", "normal");
            doc.text(bancoAtivo, 60, 75);
            
            let yPos = 80;
            
            // Se o banco estiver inativo, mostrar mensagem
            if (!func.bancoHorasAtivo) {
                doc.setFontSize(9);
                doc.setTextColor(200, 50, 50);
                doc.text("Observação: O banco de horas está inativo. O saldo total é zero e não há acúmulo.", 20, yPos);
                yPos += 10;
            }
            
            // Saldo atual
            const bancoHoras = App.calcularBancoHorasFuncionario(func.id);
            const status = bancoHoras >= 0 ? 'CRÉDITO' : 'DÉBITO';
            const corStatus = bancoHoras >= 0 ? [0, 150, 0] : [200, 50, 50];
            
            yPos = Math.max(yPos, 85);
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("SALDO ATUAL DO BANCO DE HORAS", 105, yPos, { align: "center" });
            
            yPos += 10;
            doc.setFontSize(24);
            doc.setTextColor(...corStatus);
            doc.text(App.minToTime(bancoHoras), 105, yPos, { align: "center" });
            
            yPos += 10;
            doc.setFontSize(12);
            doc.text(status, 105, yPos, { align: "center" });
            
            // Histórico mensal - só mostrar se o banco estiver ativo
            yPos += 20;
            
            if (func.bancoHorasAtivo) {
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(50, 50, 50);
                doc.text("HISTÓRICO MENSAL", 20, yPos);
                
                const historico = App.getHistoricoBancoHorasFuncionario(func.id);
                const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                
                if (historico.length > 0) {
                    const tableData = [];
                    tableData.push(['Mês/Ano', 'Saldo do Mês', 'Status']);
                    
                    let saldoAcumulado = 0;
                    
                    historico.forEach(item => {
                        saldoAcumulado += item.saldoMes;
                        const mesNome = meses[item.mes];
                        const saldoColor = item.saldoMes >= 0 ? [0, 150, 0] : [200, 50, 50];
                        const statusMes = item.saldoMes >= 0 ? 'Crédito' : 'Débito';
                        
                        tableData.push([
                            `${mesNome}/${item.ano}`,
                            { content: App.minToTime(item.saldoMes), styles: { textColor: saldoColor } },
                            statusMes
                        ]);
                    });
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [tableData[0]],
                        body: tableData.slice(1),
                        theme: 'grid',
                        headStyles: { fillColor: azulPrincipal, textColor: 255, fontStyle: 'bold', halign: 'center' },
                        bodyStyles: { halign: 'center' },
                        alternateRowStyles: { fillColor: [248, 249, 252] },
                        styles: { fontSize: 9, cellPadding: 5 },
                        columnStyles: {
                            0: { cellWidth: 40 },
                            1: { cellWidth: 50 },
                            2: { cellWidth: 30 }
                        }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                } else {
                    yPos += 10;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Nenhum histórico disponível", 20, yPos);
                    yPos += 10;
                }
            } else {
                // Se o banco estiver inativo, não mostrar histórico
                doc.setFontSize(10);
                doc.setFont("helvetica", "italic");
                doc.setTextColor(150, 150, 150);
                doc.text("Histórico não disponível (banco de horas inativo).", 20, yPos);
                yPos += 10;
            }
            
            // Observações
            yPos += 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("LEGENDAS:", 20, yPos);
            
            doc.setFont("helvetica", "normal");
            const legendas = [
                "• Crédito: Funcionário tem horas extras a receber",
                "• Débito: Funcionário tem horas a compensar",
                "• O banco de horas acumula automaticamente os saldos mensais",
                "• Quando o banco está inativo, o saldo é zerado e não há acúmulo",
                "• Saldo líquido: positivo e negativo se compensam (ex: 30min extra + 30min faltante = 0)"
            ];
            
            legendas.forEach((legenda, index) => {
                doc.text(legenda, 25, yPos + 7 + (index * 5));
            });
            
            // Rodapé
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Relatório gerado automaticamente por Ponto Enterprise System", 105, 285, { align: "center" });
            
            // Salvar
            const nomeArquivo = `Relatorio_Saldo_${func.nome.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(nomeArquivo);
            showToast(`Relatório de ${func.nome} gerado com sucesso!`, 'success');
        }

        function gerarRelatorioMensalDetalhado() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const azulPrincipal = [67, 97, 238];
            
            // Cabeçalho
            doc.setFillColor(...azulPrincipal);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("RELATÓRIO MENSAL DETALHADO - BANCO DE HORAS", 105, 18, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 26, { align: "center" });
            doc.text(`Período: Todos os meses registrados | Data: ${new Date().toLocaleDateString('pt-BR')}`, 105, 32, { align: "center" });
            
            // Obtém todos os meses registrados
            const todosMeses = {};
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            // Coleta todos os meses únicos
            App.data.funcionarios.forEach(func => {
                const historico = App.getHistoricoBancoHorasFuncionario(func.id);
                historico.forEach(item => {
                    const chave = `${item.ano}_${item.mes}`;
                    if (!todosMeses[chave]) {
                        todosMeses[chave] = { ano: item.ano, mes: item.mes, funcionarios: {} };
                    }
                    todosMeses[chave].funcionarios[func.id] = item.saldoMes;
                });
            });
            
            // Converte para array e ordena
            const mesesArray = Object.values(todosMeses).sort((a, b) => {
                if (a.ano !== b.ano) return a.ano - b.ano;
                return a.mes - b.mes;
            });
            
            let yPos = 50;
            
            // Para cada mês, cria uma tabela
            mesesArray.forEach((mesInfo, index) => {
                if (index > 0 && yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                const mesNome = meses[mesInfo.mes];
                const saldoTotalMes = Object.values(mesInfo.funcionarios).reduce((sum, saldo) => sum + saldo, 0);
                
                // Título do mês
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(50, 50, 50);
                doc.text(`${mesNome}/${mesInfo.ano} - Saldo Total: ${App.minToTime(saldoTotalMes)}`, 20, yPos);
                
                // Tabela de funcionários para este mês
                const tableData = [];
                tableData.push(['Funcionário', 'Cargo', 'Saldo do Mês', 'Status', 'Banco Ativo']);
                
                App.data.funcionarios.forEach(func => {
                    const saldoMes = mesInfo.funcionarios[func.id] || 0;
                    if (saldoMes !== 0) { // Mostra apenas funcionários com saldo
                        const saldoColor = saldoMes >= 0 ? [0, 150, 0] : [200, 50, 50];
                        const status = saldoMes >= 0 ? 'Crédito' : 'Débito';
                        
                        tableData.push([
                            func.nome,
                            func.cargo,
                            { content: App.minToTime(saldoMes), styles: { textColor: saldoColor } },
                            status,
                            func.bancoHorasAtivo ? 'Sim' : 'Não'
                        ]);
                    }
                });
                
                if (tableData.length > 1) { // Se há dados além do cabeçalho
                    doc.autoTable({
                        startY: yPos + 5,
                        head: [tableData[0]],
                        body: tableData.slice(1),
                        theme: 'grid',
                        headStyles: { fillColor: azulPrincipal, textColor: 255, fontStyle: 'bold', halign: 'center' },
                        bodyStyles: { halign: 'center' },
                        alternateRowStyles: { fillColor: [248, 249, 252] },
                        styles: { fontSize: 8, cellPadding: 4 },
                        columnStyles: {
                            0: { cellWidth: 45 },
                            1: { cellWidth: 35 },
                            2: { cellWidth: 35 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 25 }
                        }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 15;
                } else {
                    yPos += 10;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Nenhum registro para este mês", 20, yPos);
                    yPos += 10;
                }
            });
            
            // Resumo final
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("RESUMO GERAL", 20, yPos);
            
            const saldoTotalEmpresa = App.atualizarResumoSaldos();
            const funcionariosCredito = App.data.funcionarios.filter(f => App.calcularBancoHorasFuncionario(f.id) >= 0).length;
            const funcionariosDebito = App.data.funcionarios.filter(f => App.calcularBancoHorasFuncionario(f.id) < 0).length;
            const funcionariosBancoAtivo = App.data.funcionarios.filter(f => f.bancoHorasAtivo).length;
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Total de Funcionários: ${App.data.funcionarios.length}`, 20, yPos);
            doc.text(`Funcionários com Crédito: ${funcionariosCredito}`, 20, yPos + 8);
            doc.text(`Funcionários com Débito: ${funcionariosDebito}`, 20, yPos + 16);
            doc.text(`Funcionários com Banco Ativo: ${funcionariosBancoAtivo}`, 20, yPos + 24);
            doc.text(`Saldo Total da Empresa: ${App.minToTime(saldoTotalEmpresa)}`, 20, yPos + 32);
            
            // Rodapé
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Relatório gerado automaticamente por Ponto Enterprise System", 105, 285, { align: "center" });
            
            // Salvar
            const date = new Date().toISOString().slice(0, 10);
            doc.save(`Relatorio_Mensal_Detalhado_${date}.pdf`);
            showToast('Relatório mensal detalhado gerado com sucesso!', 'success');
        }

        // ==========================================
        // NOVA FUNÇÃO: Relatório Consolidado por Período
        // ==========================================

        function gerarRelatorioConsolidadoPeriodo() {
            const dataInicial = document.getElementById('periodoDataInicial').value;
            const dataFinal = document.getElementById('periodoDataFinal').value;
            const funcId = document.getElementById('periodoFuncionario').value;
            const tipoRelatorio = document.getElementById('periodoTipoRelatorio').value;
            
            if (!dataInicial || !dataFinal) {
                showToast('Selecione o período corretamente', 'error');
                return;
            }
            
            if (new Date(dataInicial) > new Date(dataFinal)) {
                showToast('A data inicial não pode ser maior que a data final', 'error');
                return;
            }
            
            // Obter dados consolidados
            const dados = App.getDetalhesPeriodoConsolidado(dataInicial, dataFinal, funcId);
            
            if (dados.funcionarios.length === 0) {
                showToast('Nenhum dado encontrado para o período selecionado', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            const azulPrincipal = [67, 97, 238];
            
            // Cabeçalho
            doc.setFillColor(...azulPrincipal);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("RELATÓRIO CONSOLIDADO POR PERÍODO", 105, 18, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 26, { align: "center" });
            doc.text(`Período: ${dados.periodo.dataInicial} a ${dados.periodo.dataFinal} | Data: ${new Date().toLocaleDateString('pt-BR')}`, 105, 32, { align: "center" });
            
            let yPos = 50;
            
            // Resumo do Período
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("RESUMO DO PERÍODO", 20, yPos);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Período Analisado: ${dados.periodo.dataInicial} a ${dados.periodo.dataFinal}`, 20, yPos + 8);
            doc.text(`Meses Incluídos: ${dados.periodo.meses.length} meses`, 20, yPos + 16);
            doc.text(`Funcionários Analisados: ${dados.totais.funcionariosAnalisados}`, 20, yPos + 24);
            doc.text(`Horas Extras Totais: ${App.minToTime(dados.totais.horasExtras)}`, 20, yPos + 32);
            doc.text(`Horas Faltantes Totais: ${App.minToTime(dados.totais.horasFaltantes)}`, 20, yPos + 40);
            
            const saldoCor = dados.totais.saldoTotal >= 0 ? [0, 150, 0] : [200, 50, 50];
            doc.setTextColor(...saldoCor);
            doc.setFont("helvetica", "bold");
            doc.text(`SALDO CONSIDERADO NO PERÍODO: ${App.minToTime(dados.totais.saldoTotal)}`, 20, yPos + 48);
            
            doc.setTextColor(50, 50, 50);
            yPos += 60;
            
            // Tabela de Funcionários
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DETALHAMENTO POR FUNCIONÁRIO", 20, yPos);
            
            const tableData = [];
            tableData.push([
                { content: 'Funcionário', styles: { fontStyle: 'bold' } },
                { content: 'Cargo', styles: { fontStyle: 'bold' } },
                { content: 'Matrícula', styles: { fontStyle: 'bold' } },
                { content: 'Saldo no Período', styles: { fontStyle: 'bold' } },
                { content: 'Status', styles: { fontStyle: 'bold' } },
                { content: 'Banco Ativo', styles: { fontStyle: 'bold' } }
            ]);
            
            dados.funcionarios.forEach(func => {
                tableData.push([
                    func.nome,
                    func.cargo,
                    func.codigo,
                    { content: func.saldoFormatado, styles: { textColor: func.saldoPeriodo >= 0 ? [0, 150, 0] : [200, 50, 50] } },
                    func.status,
                    func.bancoAtivo ? 'Sim' : 'Não'
                ]);
            });
            
            // Adicionar linha de total
            tableData.push([
                { content: 'TOTAL CONSIDERADO NO PERÍODO', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                { content: App.minToTime(dados.totais.saldoTotal), styles: { fontStyle: 'bold', textColor: dados.totais.saldoTotal >= 0 ? [0, 150, 0] : [200, 50, 50] } },
                { content: '', styles: { fontStyle: 'bold' } }
            ]);
            
            doc.autoTable({
                startY: yPos + 5,
                head: [tableData[0]],
                body: tableData.slice(1, -1),
                foot: [tableData[tableData.length - 1]],
                theme: 'grid',
                headStyles: { fillColor: azulPrincipal, textColor: 255, fontStyle: 'bold', halign: 'center' },
                footStyles: { fillColor: [240, 240, 240], textColor: [50, 50, 50], fontStyle: 'bold' },
                bodyStyles: { halign: 'center' },
                alternateRowStyles: { fillColor: [248, 249, 252] },
                styles: { fontSize: 9, cellPadding: 5 },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 25 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 25 }
                }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            // Detalhes dos meses incluídos (se for relatório detalhado)
            if (tipoRelatorio === 'detalhado' || tipoRelatorio === 'comparativo') {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(50, 50, 50);
                doc.text("MESES INCLUÍDOS NO PERÍODO", 20, yPos);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                
                let mesesTexto = '';
                dados.periodo.meses.forEach((mes, index) => {
                    mesesTexto += `${mes.mesNome}/${mes.ano}`;
                    if (index < dados.periodo.meses.length - 1) {
                        mesesTexto += ', ';
                    }
                    if ((index + 1) % 3 === 0) {
                        mesesTexto += '\n';
                    }
                });
                
                const mesesLines = mesesTexto.split('\n');
                mesesLines.forEach((line, index) => {
                    doc.text(line, 20, yPos + 10 + (index * 5));
                });
                
                yPos += 20 + (mesesLines.length * 5);
            }
            
            // Se for relatório comparativo, adicionar análise por mês
            if (tipoRelatorio === 'comparativo' && dados.funcionarios.length > 0) {
                if (yPos > 180) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(50, 50, 50);
                doc.text("ANÁLISE COMPARATIVA MENSAL", 20, yPos);
                
                yPos += 10;
                
                // Para cada funcionário, mostrar saldo por mês
                dados.funcionarios.forEach(func => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text(`${func.nome} - Saldo Total: ${func.saldoFormatado}`, 20, yPos);
                    
                    // Obter histórico do funcionário
                    const historico = App.getHistoricoBancoHorasFuncionario(func.id);
                    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    
                    yPos += 8;
                    doc.setFont("helvetica", "normal");
                    
                    let linhaMeses = '';
                    historico.forEach((item, index) => {
                        // Verificar se o mês está dentro do período
                        const dataItem = new Date(item.ano, item.mes, 1);
                        const dataIni = new Date(dataInicial);
                        const dataFim = new Date(dataFinal);
                        
                        if (dataItem >= dataIni && dataItem <= dataFim) {
                            const saldoColor = item.saldoMes >= 0 ? [0, 150, 0] : [200, 50, 50];
                            linhaMeses += `${meses[item.mes]}/${item.ano}: ${App.minToTime(item.saldoMes)}`;
                            if (index < historico.length - 1) {
                                linhaMeses += ' | ';
                            }
                        }
                    });
                    
                    const linhas = linhaMeses.split(' | ');
                    linhas.forEach((linha, index) => {
                        doc.text(linha, 25, yPos + (index * 5));
                    });
                    
                    yPos += (linhas.length * 5) + 10;
                });
            }
            
            // Observações
            if (yPos > 230) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(50, 50, 50);
            doc.text("OBSERVAÇÕES:", 20, yPos);
            
            doc.setFont("helvetica", "normal");
            const observacoes = [
                "1. Este relatório consolida o saldo de horas no período selecionado.",
                "2. O saldo considera a diferença entre horas trabalhadas e jornada contratual.",
                "3. Valores positivos indicam horas extras (crédito).",
                "4. Valores negativos indicam horas faltantes (débito).",
                "5. O período inclui todos os meses completos entre as datas selecionadas.",
                "6. Quando o Banco de Horas está inativo, o saldo é zerado para o período.",
                "7. Saldo líquido: positivo e negativo se compensam automaticamente."
            ];
            
            observacoes.forEach((obs, index) => {
                doc.text(obs, 25, yPos + 7 + (index * 5));
            });
            
            // Rodapé
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Relatório gerado automaticamente por Ponto Enterprise System", 105, 285, { align: "center" });
            
            // Salvar
            const date = new Date().toISOString().slice(0, 10);
            const nomeArquivo = `Relatorio_Consolidado_${date}_${dataInicial}_a_${dataFinal}.pdf`;
            doc.save(nomeArquivo);
            
            fecharModalPeriodoConsolidado();
            showToast('Relatório consolidado gerado com sucesso!', 'success');
        }

        // --- Funções para Recibo de Horas Extras ---
        function gerarReciboHorasExtras() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const func = App.getFuncionarioAtual();
            
            if (!func) {
                showToast('Selecione um funcionário primeiro', 'error');
                return;
            }
            
            const horasExtras = App.calcularHorasExtrasMes();
            
            // Se não há horas extras, avisar
            if (horasExtras.total <= 0) {
                showToast('Não há horas extras para gerar recibo neste período', 'warning');
                return;
            }

            // Cores
            const verde = [76, 201, 240];
            const azul = [67, 97, 238];
            const cinza = [100, 100, 100];

            // Cabeçalho
            doc.setFillColor(...azul);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("RECIBO DE PAGAMENTO DE HORAS EXTRAS", 105, 15, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 23, { align: "center" });
            doc.text("Documento Oficial para Fins de Pagamento", 105, 29, { align: "center" });

            // Informações do Funcionário
            doc.setFillColor(245, 247, 250);
            doc.roundedRect(15, 40, 180, 25, 3, 3, 'F');
            
            doc.setTextColor(...cinza);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("FUNCIONÁRIO:", 20, 50);
            doc.text("CARGO:", 120, 50);
            doc.text("MATRÍCULA:", 20, 60);
            doc.text("PERÍODO:", 120, 60);

            doc.setFont("helvetica", "normal");
            doc.text(func.nome.toUpperCase(), 45, 50);
            doc.text(func.cargo.toUpperCase(), 140, 50);
            doc.text(func.codigo, 45, 60);
            doc.text(`${document.getElementById('selectMes').options[document.getElementById('selectMes').selectedIndex].text}/${App.ui.anoAtual}`, 140, 60);

            // Detalhes das Horas Extras
            let yPos = 75;
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("DETALHAMENTO DAS HORAS EXTRAS", 105, yPos, { align: "center" });
            
            yPos += 15;
            
            // Tabela de horas extras
            const tableData = [
                ['Tipo de Hora Extra', 'Percentual', 'Quantidade (Horas)', 'Valor por Hora (R$)', 'Valor Total (R$)'],
                ['Horas Extras Normais', '50%', App.minToDecimal(horasExtras.normais), 'A definir', 'A calcular'],
                ['Horas Extras em Feriados', '100%', App.minToDecimal(horasExtras.feriado), 'A definir', 'A calcular'],
                ['Horas Extras em Domingos', '100%', App.minToDecimal(horasExtras.domingo), 'A definir', 'A calcular'],
                ['Horas Extras em Folgas', '100%', App.minToDecimal(horasExtras.folga), 'A definir', 'A calcular'],
                ['TOTAL GERAL', '', App.minToDecimal(horasExtras.total), '', '']
            ];

            doc.autoTable({
                startY: yPos,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                headStyles: { fillColor: azul, textColor: 255, fontStyle: 'bold', halign: 'center' },
                bodyStyles: { halign: 'center' },
                alternateRowStyles: { fillColor: [248, 249, 252] },
                styles: { fontSize: 9, cellPadding: 5 },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 40 },
                    4: { cellWidth: 35 }
                }
            });

            yPos = doc.lastAutoTable.finalY + 15;

            // Observações
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("OBSERVAÇÕES:", 20, yPos);
            
            doc.setFont("helvetica", "normal");
            const observacoes = [
                "1. Este documento tem validade legal para fins de pagamento.",
                "2. Os valores serão calculados conforme contrato de trabalho.",
                "3. Horas extras em feriados, domingos e folgas têm acréscimo de 100%.",
                "4. Horas extras normais têm acréscimo de 50%.",
                "5. Para pagamento, apresentar este recibo ao departamento financeiro."
            ];
            
            observacoes.forEach((obs, index) => {
                doc.text(obs, 25, yPos + 7 + (index * 5));
            });

            yPos += 40;

            // Assinaturas
            doc.setDrawColor(0, 0, 0);
            doc.line(30, yPos, 80, yPos);
            doc.setFontSize(9);
            doc.text("ASSINATURA DO FUNCIONÁRIO", 55, yPos + 5, { align: "center" });

            doc.line(130, yPos, 180, yPos);
            doc.text("ASSINATURA DO RESPONSÁVEL", 155, yPos + 5, { align: "center" });

            yPos += 20;

            // Rodapé
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Recibo gerado automaticamente por Ponto Enterprise System", 105, 285, { align: "center" });
            doc.text(`Data de emissão: ${new Date().toLocaleDateString('pt-BR')}`, 105, 290, { align: "center" });

            // Salvar
            doc.save(`Recibo_Horas_Extras_${func.nome.replace(/\s+/g, '_')}_${App.ui.mesAtual+1}_${App.ui.anoAtual}.pdf`);
            
            // Após gerar o recibo, perguntar se deseja dar baixa no banco de horas
            if (func.bancoHorasAtivo) {
                const bancoAtual = App.calcularBancoHorasFuncionario(func.id);
                if (bancoAtual > 0) {
                    setTimeout(() => {
                        if (confirm(`Deseja dar baixa no banco de horas após gerar este recibo?\n\nSaldo atual: ${App.minToTime(bancoAtual)}\nHoras no recibo: ${App.minToTime(horasExtras.total)}\n\nAs horas serão subtraídas do banco de horas.`)) {
                            // Dar baixa das horas extras no banco de horas
                            const sucesso = App.registrarBaixaBancoHoras(
                                func.id, 
                                horasExtras.total, 
                                'pagamento', 
                                `Recibo horas extras - ${App.ui.mesAtual+1}/${App.ui.anoAtual}`
                            );
                            
                            if (sucesso) {
                                showToast('Baixa registrada no banco de horas!', 'success');
                            }
                        }
                    }, 500);
                }
            }
            
            showToast('Recibo de horas extras gerado com sucesso!', 'success');
        }

        function gerarPDFModerno() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const func = App.getFuncionarioAtual();
            
            if (!func) {
                showToast('Selecione um funcionário primeiro', 'error');
                return;
            }
            
            const azulPrincipal = [67, 97, 238];
            const cinzaEscuro = [50, 50, 50];

            doc.setFillColor(...azulPrincipal);
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("ESPELHO DE PONTO", 105, 18, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`${App.data.empresa.nome} | CNPJ: ${App.data.empresa.cnpj}`, 105, 26, { align: "center" });
            doc.text(`Período: ${document.getElementById('selectMes').options[document.getElementById('selectMes').selectedIndex].text}/${App.ui.anoAtual}`, 105, 32, { align: "center" });

            doc.setFillColor(245, 247, 250);
            doc.setDrawColor(200, 200, 200);
            doc.roundedRect(14, 45, 182, 25, 3, 3, 'FD');

            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("FUNCIONÁRIO:", 20, 55);
            doc.text("CARGO:", 120, 55);
            doc.text("MATRÍCULA:", 20, 65);
            doc.text("JORNADA:", 120, 65);

            doc.setFont("helvetica", "normal");
            doc.text(func.nome.toUpperCase(), 50, 55);
            doc.text(func.cargo.toUpperCase(), 140, 55);
            doc.text(func.codigo, 50, 65);
            doc.text(`${func.jornada} HORAS`, 140, 65);

            const bodyData = [];
            const key = App.getKeyRegistro();
            const registrosMes = App.data.registros[key] || {};
            const diasNoMes = new Date(App.ui.anoAtual, App.ui.mesAtual + 1, 0).getDate();
            
            let totalTrabalhado = 0;
            let totalSaldo = 0;

            for (let d = 1; d <= diasNoMes; d++) {
                const dataObj = new Date(App.ui.anoAtual, App.ui.mesAtual, d);
                const diaSemana = dataObj.getDay();
                const diaNome = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][diaSemana];
                const reg = registrosMes[d] || {};
                
                const calc = App.calcularDiaComExpediente(reg, func.jornada, dataObj);
                
                const y = dataObj.getFullYear();
                const m = (dataObj.getMonth() + 1).toString().padStart(2, '0');
                const dd = d.toString().padStart(2, '0');
                const dataFormatada = `${y}-${m}-${dd}`;
                const isFeriado = App.isFeriado(dataFormatada);
                const isFolga = App.isFolga(dataFormatada);
                const isAtestadoDay = calc.isAtestadoDay;

                if (calc.teveBatida || isAtestadoDay || (!isFeriado && !isFolga && diaSemana !== 0)) {
                    totalTrabalhado += calc.trabalhado;
                    totalSaldo += calc.saldo;
                }

                let textColor = [0, 0, 0];
                let fillColor = [255, 255, 255];
                let diaComplemento = '';

                if(isFeriado || diaSemana === 0 || isFolga) {
                    if (isFeriado) {
                        fillColor = [255, 234, 234];
                        textColor = [150, 0, 0];
                        diaComplemento = ' (Fer)';
                    } else if (diaSemana === 0) {
                        fillColor = [255, 234, 234];
                        textColor = [150, 0, 0];
                        diaComplemento = ' (Dom)';
                    } else if (isFolga) {
                        fillColor = [255, 248, 225];
                        textColor = [200, 100, 0];
                        diaComplemento = ' (Folga)';
                    }
                }
                
                if (isAtestadoDay) {
                    fillColor = [230, 247, 255];
                    textColor = [24, 144, 255];
                    diaComplemento = ' (Ates)';
                }

                bodyData.push([
                    { content: `${d.toString().padStart(2,'0')}/${(App.ui.mesAtual+1).toString().padStart(2,'0')}`, styles: { fontStyle: 'bold', fillColor: fillColor } },
                    { content: diaNome + diaComplemento, styles: { fillColor: fillColor, textColor: textColor } },
                    reg.e1 || '-',
                    reg.s1 || '-',
                    reg.e2 || '-',
                    reg.s2 || '-',
                    App.minToTime(calc.trabalhado),
                    { content: App.minToTime(calc.saldo), styles: { textColor: calc.saldo < 0 ? [200, 50, 50] : [0, 150, 0], fontStyle: 'bold' } }
                ]);
            }

            doc.autoTable({
                startY: 75,
                head: [['Data', 'Dia', 'Ent. 1', 'Saí. 1', 'Ent. 2', 'Saí. 2', 'Total', 'Saldo']],
                body: bodyData,
                theme: 'grid',
                headStyles: { fillColor: azulPrincipal, textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { halign: 'center' },
                    1: { halign: 'center' },
                    2: { halign: 'center' },
                    3: { halign: 'center' },
                    4: { halign: 'center' },
                    5: { halign: 'center' },
                    6: { halign: 'center', fontStyle: 'bold' },
                    7: { halign: 'center', fontStyle: 'bold' }
                },
                alternateRowStyles: { fillColor: [248, 249, 252] },
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            
            // Banco de Horas
            const bancoHoras = App.calcularBancoHorasFuncionario();
            const saldoFinalEmMinutos = totalSaldo;
            const saldoTotal = bancoHoras + saldoFinalEmMinutos;
            
            const statusSaldo = saldoTotal >= 0 ? 'POSITIVO (Crédito)' : 'NEGATIVO (Débito)';
            const corStatus = saldoTotal >= 0 ? [0, 150, 0] : [200, 50, 50];

            doc.setFillColor(240, 240, 240);
            doc.rect(14, finalY, 182, 40, 'F');
            doc.setTextColor(...cinzaEscuro);
            doc.setFontSize(11);

            doc.setFont("helvetica", "bold");
            doc.text("BALANÇO GERAL DO PERÍODO", 20, finalY + 8);
            
            doc.setFont("helvetica", "normal");
            doc.text(`TOTAL TRABALHADO: ${App.minToTime(totalTrabalhado)}`, 20, finalY + 16);
            doc.text(`SALDO DO MÊS: ${App.minToTime(saldoFinalEmMinutos)}`, 20, finalY + 24);
            doc.text(`BANCO DE HORAS: ${App.minToTime(bancoHoras)}`, 120, finalY + 16);
            doc.text(`SALDO TOTAL: ${App.minToTime(saldoTotal)}`, 120, finalY + 24);
            
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...corStatus);
            doc.text(`STATUS: ${statusSaldo}`, 20, finalY + 34);
            
            doc.setTextColor(...cinzaEscuro);
            
            finalY += 60;
            doc.setDrawColor(0, 0, 0);
            
            doc.line(20, finalY, 90, finalY);
            doc.setFontSize(9);
            doc.text("ASSINATURA DO EMPREGADOR", 55, finalY + 5, { align: "center" });
            
            doc.line(120, finalY, 190, finalY);
            doc.text("ASSINATURA DO FUNCIONÁRIO", 155, finalY + 5, { align: "center" });

            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text("Gerado por Ponto Enterprise System", 105, 290, { align: "center" });

            doc.save(`Ponto_${func.nome.replace(/\s+/g, '_')}_${App.ui.mesAtual+1}_${App.ui.anoAtual}.pdf`);
            showToast('PDF gerado com sucesso!', 'success');
        }

        function exportarTabelaExcel() {
            const func = App.getFuncionarioAtual();
            if (!func) {
                showToast('Selecione um funcionário primeiro', 'error');
                return;
            }
            
            const key = App.getKeyRegistro();
            const registrosMes = App.data.registros[key] || {};
            const diasNoMes = new Date(App.ui.anoAtual, App.ui.mesAtual + 1, 0).getDate();
            
            let csv = "Data;Dia da Semana;Entrada 1;Saida 1;Entrada 2;Saida 2;Total Horas;Saldo;Observação\n";
            
            for(let d=1; d<=diasNoMes; d++) {
                const r = registrosMes[d] || {};
                const dataObj = new Date(App.ui.anoAtual, App.ui.mesAtual, d);
                const data = `${d}/${App.ui.mesAtual+1}/${App.ui.anoAtual}`;
                const diaSemana = dataObj.toLocaleDateString('pt-BR', {weekday: 'short'});
                
                const calc = App.calcularDiaComExpediente(r, func.jornada, dataObj);
                
                csv += `${data};${diaSemana};${r.e1||''};${r.s1||''};${r.e2||''};${r.s2||''};${App.minToTime(calc.trabalhado)};${App.minToTime(calc.saldo)};${calc.observacao || ''}\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `ponto_${func.nome}_${App.ui.mesAtual+1}.csv`);
            link.click();
        }
        
        // Inicializar evento para atualizar saldo ao selecionar funcionário na modal de baixa
        document.getElementById('baixaFuncionario').addEventListener('change', atualizarSaldoBaixa);
    </script>
</body>
</html>
